+++
title = '聚合分析'
date = 2020-06-25T20:43:49+08:00
draft = true
categories = [ "ElasticSearch" ]
tags = [ "es" ]
+++

## 什么是聚合分析

* 搜索引擎用来做什么？

搜索引擎是用来过滤和搜索的问题的，比如

    - 请告诉我地址为上海的所有订单

    - 请告诉我最近1天内创建但没有付款的所有订单

* 聚合分析用来做什么?

    - 请告诉我最近1周每天的订单成交量有多少？（最终期待的不是订单，而是订单的数量）

    - 请告诉我最近1一个月每天的平均订单金额是多少？（关注的不是订单列表，而是订单的金额）

    - 请告诉我最近半年卖的最火的前5个商品有哪些？（关注的不是订单列表，而是商品）

* 聚合分析

聚合分析，英文为 Aggregation, 是es除了搜索功能外提供的针对es数据做统计分析的功能

    - 功能丰富，提供 Bucket, Metric, Pipeline 等多种分析方式，可以满足大部分的分析需求

    - 实时性高，所有的计算结果都是即时返回的，而 hadoop 等大数据系统一般都是T+1级别的

* 聚合分析-分类

为了便于理解，es将聚合分析主要分为如下4类

- Bucket, 分桶类型，类似SQL中的 GROUP BY 语法

- Metric, 指标分类类型，如计算最大值，最小值，平均值等等

- Pipeline, 管道分类类型，基于上一级的聚合分析结果进行再分析

- Matrix, 矩阵分析类型

### metric 聚合分析

主要分两类

* 单值分析，只输出一个分析结果

    - min, max, avg, sum

    - cardinality

* 多值分析，输出多个分析结果

    - stats, extended stats

    - percentile, percentile rank

    - top hits

#### Min

返回数值类字段的最小值

- reqeust

```
{
  "size": 0,
  "aggs": {
    "min_age": {
      "min": {
        "field": "age"
      }
    }
  }
}
```

- response

```
{
  "took": 70,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": 4,
    "max_score": 0,
    "hits": []
  },
  "aggregations": {
    "min_age": {
      "value": 18
    }
  }
}
```

#### Max

返回数值类字段的最大值

- request

```
GET test_search_index/_search
{
  "size": 0,
  "aggs": {
    "max_age": {
      "max": {
        "field": "age"
      }
    }
  }
}
```

- response

```
{
  "took": 4,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": 4,
    "max_score": 0,
    "hits": []
  },
  "aggregations": {
    "max_age": {
      "value": 28
    }
  }
}
```

#### Sum

返回数值类型字段的总和

- request

```
GET test_search_index/_search
{
  "size": 0,
  "aggs": {
    "avg_age": {
      "avg": {
        "field": "age"
      }
    }
  }
}
```

- response

```
{
  "took": 7,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": 4,
    "max_score": 0,
    "hits": []
  },
  "aggregations": {
    "avg_age": {
      "value": 22.75
    }
  }
}
```

#### 一次返回多个聚合结果

-request

```
GET test_search_index/_search
{
  "size": 0,
  "aggs": {
    "min_age": {
      "min": {
        "field": "age"
      }
    },
    "max_age": {
      "max": {
        "field": "age"
      }
    },
    "avg_age": {
      "avg": {
        "field": "age"
      }
    },
    "sum_age": {
      "sum": {
        "field": "age"
      }
    }
  }
}
```

- response

```
{
  "took": 8,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": 4,
    "max_score": 0,
    "hits": []
  },
  "aggregations": {
    "max_age": {
      "value": 28
    },
    "avg_age": {
      "value": 22.75
    },
    "sum_age": {
      "value": 91
    },
    "min_age": {
      "value": 18
    }
  }
}
```

#### Cardinality

Cardinality，意为集合的势，或者基数，是指不同数值的个数，类似 SQL 中的 distinct count 概念

- request

```
GET test_search_index/_search
{
  "size": 0,
  "aggs": {
    "count_of_job": {
      "cardinality": {
        "field": "job.keyword"
      }
    }
  }
}
```

- response

```
{
  "took": 27,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": 4,
    "max_score": 0,
    "hits": []
  },
  "aggregations": {
    "count_of_job": {
      "value": 4
    }
  }
}
```

#### Stats

多值分析，返回一系列数值类型的统计值，包含min, max, avg, sum, count

- reqeust

```
GET test_search_index/_search
{
  "size": 0,
  "aggs": {
    "stats_age": {
      "stats": {
        "field": "age"
      }
    }
  }
}
```

- response

```
{
  "took": 4,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": 4,
    "max_score": 0,
    "hits": []
  },
  "aggregations": {
    "stats_age": {
      "count": 4,
      "min": 18,
      "max": 28,
      "avg": 22.75,
      "sum": 91
    }
  }
}
```

#### Extended Stats

对 stats 的扩展，包含统计更多的统计数据，如方差，标准差等

- request

```
GET test_search_index/_search
{
  "size": 0,
  "aggs": {
    "stats_age": {
      "extended_stats": {
        "field": "salary"
      }
    }
  }
}
```

- response 

```
{
  "took": 1,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": 6,
    "max_score": 1,
    "hits": [
      {
        "_index": "test_search_index",
        "_type": "doc",
        "_id": "1",
        "_score": 1,
        "_source": {
          "username": "alfred way",
          "job": "java engineer",
          "age": 18,
          "birth": "1990-01-02",
          "isMarried": false,
          "salary": 10000
        }
      },
      {
        "_index": "test_search_index",
        "_type": "doc",
        "_id": "2",
        "_score": 1,
        "_source": {
          "username": "tom",
          "job": "java senior engineer",
          "age": 28,
          "birth": "1980-05-07",
          "isMarried": true,
          "salary": 30000
        }
      },
      {
        "_index": "test_search_index",
        "_type": "doc",
        "_id": "3",
        "_score": 1,
        "_source": {
          "username": "lee",
          "job": "ruby engineer",
          "age": 22,
          "birth": "1985-08-07",
          "isMarried": false,
          "salary": 15000
        }
      },
      {
        "_index": "test_search_index",
        "_type": "doc",
        "_id": "4",
        "_score": 1,
        "_source": {
          "username": "Nick",
          "job": "web engineer",
          "age": 23,
          "birth": "1989-08-07",
          "isMarried": false,
          "salary": 8000
        }
      },
      {
        "_index": "test_search_index",
        "_type": "doc",
        "_id": "5",
        "_score": 1,
        "_source": {
          "username": "Niko",
          "job": "web engineer",
          "age": 18,
          "birth": "1994-08-07",
          "isMarried": false,
          "salary": 5000
        }
      },
      {
        "_index": "test_search_index",
        "_type": "doc",
        "_id": "6",
        "_score": 1,
        "_source": {
          "username": "Michell",
          "job": "ruby engineer",
          "age": 26,
          "birth": "1987-08-07",
          "isMarried": false,
          "salary": 12000
        }
      }
    ]
  },
  "aggregations": {
    "stats_age": {
      "count": 6,
      "min": 5000,
      "max": 30000,
      "avg": 13333.333333333334,
      "sum": 80000,
      "sum_of_squares": 1458000000,
      "variance": 65222222.22222223,
      "std_deviation": 8076.027626390479,
      "std_deviation_bounds": {
        "upper": 29485.38858611429,
        "lower": -2818.721919447624
      }
    }
  }
}
```

#### Percentile

百分位数统计

- request

```
GET test_search_index/_search
{
  "size": 0,
  "aggs": {
    "per_salary": {
      "percentiles": {
        "field": "salary"
      }
    }
  }
}
```

- response

```
{
  "took": 18,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": 6,
    "max_score": 0,
    "hits": []
  },
  "aggregations": {
    "per_salary": {
      "values": {
        "1.0": 5000,
        "5.0": 5000,
        "25.0": 8000,
        "50.0": 11000,
        "75.0": 15000,
        "95.0": 30000,
        "99.0": 30000
      }
    }
  }
}
```

#### Percentile Rank

百分位数统计,可以输入一个值得到该值在所有的值里面所处的位置排名

- reqeust

```
GET test_search_index/_search
{
  "size": 0,
  "aggs": {
    "per_salary": {
      "percentile_ranks": {
        "field": "salary",
        "values": [
          11000,
          30000
        ]
      }
    }
  }
}
```

- response

```
{
  "took": 1,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": 6,
    "max_score": 0,
    "hits": []
  },
  "aggregations": {
    "per_salary": {
      "values": {
        "11000.0": 50,
        "30000.0": 100
      }
    }
  }
}
```

得到的值是统一一些统计算法计算的，不一定和我我们预期的是完全准确，它里面有一些概率算法

也可以指定一些百分位的值

- reqeust

```
GET test_search_index/_search
{
  "size": 0,
  "aggs": {
    "per_salary": {
      "percentiles": {
        "field": "salary",
        "percents": [
          95,
          99,
          99.9
        ]
      }
    }
  }
}
```

- response

```
{
  "took": 1,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": 6,
    "max_score": 0,
    "hits": []
  },
  "aggregations": {
    "per_salary": {
      "values": {
        "95.0": 30000,
        "99.0": 30000,
        "99.9": 30000
      }
    }
  }
}
```

#### Top Hits

一般用于分桶后获取该桶内最匹配的顶部文档列表

- request

```
GET test_search_index/_search
{
  "size": 0,
  "aggs": {
    "jobs": {
      "terms": {
        "field": "job.keyword",
        "size": 10
      },
      "aggs": {
        "top_employee": {
          "top_hits": {
            "size": 10,
            "sort": [
              {
                "age": {
                  "order": "desc"
                }
              }
            ]
          }
        }
      }
    }
  }
}
```

- response

```
{
  "took": 22,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": 6,
    "max_score": 0,
    "hits": []
  },
  "aggregations": {
    "jobs": {
      "doc_count_error_upper_bound": 0,
      "sum_other_doc_count": 0,
      "buckets": [
        {
          "key": "ruby engineer",
          "doc_count": 2,
          "top_employee": {
            "hits": {
              "total": 2,
              "max_score": null,
              "hits": [
                {
                  "_index": "test_search_index",
                  "_type": "doc",
                  "_id": "6",
                  "_score": null,
                  "_source": {
                    "username": "Michell",
                    "job": "ruby engineer",
                    "age": 26,
                    "birth": "1987-08-07",
                    "isMarried": false,
                    "salary": 12000
                  },
                  "sort": [
                    26
                  ]
                },
                {
                  "_index": "test_search_index",
                  "_type": "doc",
                  "_id": "3",
                  "_score": null,
                  "_source": {
                    "username": "lee",
                    "job": "ruby engineer",
                    "age": 22,
                    "birth": "1985-08-07",
                    "isMarried": false,
                    "salary": 15000
                  },
                  "sort": [
                    22
                  ]
                }
              ]
            }
          }
        },
        {
          "key": "web engineer",
          "doc_count": 2,
          "top_employee": {
            "hits": {
              "total": 2,
              "max_score": null,
              "hits": [
                {
                  "_index": "test_search_index",
                  "_type": "doc",
                  "_id": "4",
                  "_score": null,
                  "_source": {
                    "username": "Nick",
                    "job": "web engineer",
                    "age": 23,
                    "birth": "1989-08-07",
                    "isMarried": false,
                    "salary": 8000
                  },
                  "sort": [
                    23
                  ]
                },
                {
                  "_index": "test_search_index",
                  "_type": "doc",
                  "_id": "5",
                  "_score": null,
                  "_source": {
                    "username": "Niko",
                    "job": "web engineer",
                    "age": 18,
                    "birth": "1994-08-07",
                    "isMarried": false,
                    "salary": 5000
                  },
                  "sort": [
                    18
                  ]
                }
              ]
            }
          }
        },
        {
          "key": "java engineer",
          "doc_count": 1,
          "top_employee": {
            "hits": {
              "total": 1,
              "max_score": null,
              "hits": [
                {
                  "_index": "test_search_index",
                  "_type": "doc",
                  "_id": "1",
                  "_score": null,
                  "_source": {
                    "username": "alfred way",
                    "job": "java engineer",
                    "age": 18,
                    "birth": "1990-01-02",
                    "isMarried": false,
                    "salary": 10000
                  },
                  "sort": [
                    18
                  ]
                }
              ]
            }
          }
        },
        {
          "key": "java senior engineer",
          "doc_count": 1,
          "top_employee": {
            "hits": {
              "total": 1,
              "max_score": null,
              "hits": [
                {
                  "_index": "test_search_index",
                  "_type": "doc",
                  "_id": "2",
                  "_score": null,
                  "_source": {
                    "username": "tom",
                    "job": "java senior engineer",
                    "age": 28,
                    "birth": "1980-05-07",
                    "isMarried": true,
                    "salary": 30000
                  },
                  "sort": [
                    28
                  ]
                }
              ]
            }
          }
        }
      ]
    }
  }
}
```

## Bucket 聚合分析

Bucket 意思是桶，即按照一定的规则将文档分配到不同的桶中，达到分类分析的目的

比如有一堆文档，并且有三个桶，三个桶有不同的规则，比如第一个桶是年龄小于10(age < 10>)的，
第二个同时年轻大于等于10小于等于30的(10<=age<30>),第三个桶是年龄大于等于30的(age>=30)，然后不同的文档根据不同的年龄分到不同的桶里，从而实现了分类

按照 Bucket 的分桶策略，常见的 Bucket 聚合分析如下

    - Terms

    - Range

    - Date Range

    - Histogram

    - Date Histogram

### Terms

该分桶策略最简单，直接按照 term 来分桶，如果是 text 类型，则按照分词后的结果分桶

- request

keyword 不分词

```
GET test_search_index/_search
{
  "size": 0,
  "aggs": {
    "jobs": {
      "terms": {
        "field": "job.keyword",
        "size": 3
      }
    }
  }
}
```

- response

```
{
  "took": 0,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": 6,
    "max_score": 0,
    "hits": []
  },
  "aggregations": {
    "jobs": {
      "doc_count_error_upper_bound": 0,
      "sum_other_doc_count": 1,
      "buckets": [
        {
          "key": "ruby engineer",
          "doc_count": 2
        },
        {
          "key": "web engineer",
          "doc_count": 2
        },
        {
          "key": "java engineer",
          "doc_count": 1
        }
      ]
    }
  }
}
```

- reqeust

对 test 类型进行分析需要将fielddata打开

```
GET test_search_index

PUT test_search_index/_mapping/doc
{
  "properties": {
    "job": {
      "type": "text",
      "fielddata": true
    }
  }
}

GET test_search_index/_search
{
  "size": 0,
  "aggs": {
    "jobs": {
      "terms": {
        "field": "job",
        "size": 3
      }
    }
  }
}
```

- response

```
{
  "took": 2,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": 6,
    "max_score": 0,
    "hits": []
  },
  "aggregations": {
    "jobs": {
      "doc_count_error_upper_bound": 0,
      "sum_other_doc_count": 3,
      "buckets": [
        {
          "key": "engineer",
          "doc_count": 6
        },
        {
          "key": "java",
          "doc_count": 2
        },
        {
          "key": "ruby",
          "doc_count": 2
        }
      ]
    }
  }
}
```

### Range

通过指定数值的范围来设定分桶规则

- request

```
GET test_search_index/_search
{
  "size": 0,
  "aggs": {
    "salary_range": {
      "range": {
        "field": "salary",
        "ranges": [
          {
            "to": 10000
          },
          {
            "from": 10000,
            "to": 20000
          },
          {
            "from": 20000
          }
        ]
      }
    }
  }
}
```

- response

```
{
  "took": 4,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": 6,
    "max_score": 0,
    "hits": []
  },
  "aggregations": {
    "salary_range": {
      "buckets": [
        {
          "key": "*-10000.0",
          "to": 10000,
          "doc_count": 2
        },
        {
          "key": "10000.0-20000.0",
          "from": 10000,
          "to": 20000,
          "doc_count": 3
        },
        {
          "key": "20000.0-*",
          "from": 20000,
          "doc_count": 1
        }
      ]
    }
  }
}
```

结果中返回了 `key`,但是这个key也是可以自行指定的

- request

```
GET test_search_index/_search
{
  "size": 0,
  "aggs": {
    "salary_range": {
      "range": {
        "field": "salary",
        "ranges": [
          {
            "key": "<10000", 
            "to": 10000
          },
          {
            "from": 10000,
            "to": 20000
          },
          {
            "key": ">20000", 
            "from": 20000
          }
        ]
      }
    }
  }
}
```

- response

```
{
  "took": 0,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": 6,
    "max_score": 0,
    "hits": []
  },
  "aggregations": {
    "salary_range": {
      "buckets": [
        {
          "key": "<10000",
          "to": 10000,
          "doc_count": 2
        },
        {
          "key": "10000.0-20000.0",
          "from": 10000,
          "to": 20000,
          "doc_count": 3
        },
        {
          "key": ">20000",
          "from": 20000,
          "doc_count": 1
        }
      ]
    }
  }
}
```

### Data Range

通过指定日期的范围来设定分桶规则

- request

```
GET test_search_index/_search
{
  "size": 0,
  "aggs": {
    "date_range": {
      "range": {
        "field": "birth",
        "format": "yyyy",
        "ranges": [
          {
            "from": "1980",
            "to": "1990"
          },
          {
            "from": "1990",
            "to": "2000"
          },
          {
            "from": "2000"
          }
        ]
      }
    }
  }
}
```

- response

```
{
  "took": 3,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": 6,
    "max_score": 0,
    "hits": []
  },
  "aggregations": {
    "date_range": {
      "buckets": [
        {
          "key": "1980-1990",
          "from": 315532800000,
          "from_as_string": "1980",
          "to": 631152000000,
          "to_as_string": "1990",
          "doc_count": 4
        },
        {
          "key": "1990-2000",
          "from": 631152000000,
          "from_as_string": "1990",
          "to": 946684800000,
          "to_as_string": "2000",
          "doc_count": 2
        },
        {
          "key": "2000-*",
          "from": 946684800000,
          "from_as_string": "2000",
          "doc_count": 0
        }
      ]
    }
  }
}
```

如果不指定 `format`,就是一个标准化的日期格式化的结果

- request

```
GET test_search_index/_search
{
  "size": 0,
  "aggs": {
    "date_range": {
      "range": {
        "field": "birth",
        "ranges": [
          {
            "from": "1980",
            "to": "1990"
          },
          {
            "from": "1990",
            "to": "2000"
          },
          {
            "from": "2000"
          }
        ]
      }
    }
  }
}
```

- response

```
{
  "took": 1,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": 6,
    "max_score": 0,
    "hits": []
  },
  "aggregations": {
    "date_range": {
      "buckets": [
        {
          "key": "1980-01-01T00:00:00.000Z-1990-01-01T00:00:00.000Z",
          "from": 315532800000,
          "from_as_string": "1980-01-01T00:00:00.000Z",
          "to": 631152000000,
          "to_as_string": "1990-01-01T00:00:00.000Z",
          "doc_count": 4
        },
        {
          "key": "1990-01-01T00:00:00.000Z-2000-01-01T00:00:00.000Z",
          "from": 631152000000,
          "from_as_string": "1990-01-01T00:00:00.000Z",
          "to": 946684800000,
          "to_as_string": "2000-01-01T00:00:00.000Z",
          "doc_count": 2
        },
        {
          "key": "2000-01-01T00:00:00.000Z-*",
          "from": 946684800000,
          "from_as_string": "2000-01-01T00:00:00.000Z",
          "doc_count": 0
        }
      ]
    }
  }
}
```

### Historgram

直方图，以固定间隔的策略来分割数据

interval 指定间隔大小
extended_bounds: { 指定数据范围
    "min": 0,
    "max": 40000
}

- request

```
GET test_search_index/_search
{
  "size": 0,
  "aggs": {
    "salary_hist": {
      "histogram": {
        "field": "salary",
        "interval": 5000
      }
    }
  }
}
```

或者 

```
GET test_search_index/_search
{
  "size": 0,
  "aggs": {
    "salary_hist": {
      "histogram": {
        "field": "salary",
        "interval": 5000,
        "extended_bounds": {
          "min": 0,
          "max": 40000
        }
      }
    }
  }
}
```

- response

```
{
  "took": 3,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": 6,
    "max_score": 0,
    "hits": []
  },
  "aggregations": {
    "salary_hist": {
      "buckets": [
        {
          "key": 5000,
          "doc_count": 2
        },
        {
          "key": 10000,
          "doc_count": 2
        },
        {
          "key": 15000,
          "doc_count": 1
        },
        {
          "key": 20000,
          "doc_count": 0
        },
        {
          "key": 25000,
          "doc_count": 0
        },
        {
          "key": 30000,
          "doc_count": 1
        }
      ]
    }
  }
}
```

### Date Historgram

针对日期的直方图或者柱状图，是时序分析数据中常用的聚合分析类型

- request

```
GET test_search_index/_search
{
  "size": 0,
  "aggs": {
    "by_year": {
      "date_histogram": {
        "field": "birth",
        "interval": "year",
        "format": "yyyy"
      }
    }
  }
}
```

- response

```
{
  "took": 6,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": 6,
    "max_score": 0,
    "hits": []
  },
  "aggregations": {
    "by_year": {
      "buckets": [
        {
          "key_as_string": "1980",
          "key": 315532800000,
          "doc_count": 1
        },
        {
          "key_as_string": "1981",
          "key": 347155200000,
          "doc_count": 0
        },
        {
          "key_as_string": "1982",
          "key": 378691200000,
          "doc_count": 0
        },
        {
          "key_as_string": "1983",
          "key": 410227200000,
          "doc_count": 0
        },
        {
          "key_as_string": "1984",
          "key": 441763200000,
          "doc_count": 0
        },
        {
          "key_as_string": "1985",
          "key": 473385600000,
          "doc_count": 1
        },
        {
          "key_as_string": "1986",
          "key": 504921600000,
          "doc_count": 0
        },
        {
          "key_as_string": "1987",
          "key": 536457600000,
          "doc_count": 1
        },
        {
          "key_as_string": "1988",
          "key": 567993600000,
          "doc_count": 0
        },
        {
          "key_as_string": "1989",
          "key": 599616000000,
          "doc_count": 1
        },
        {
          "key_as_string": "1990",
          "key": 631152000000,
          "doc_count": 1
        },
        {
          "key_as_string": "1991",
          "key": 662688000000,
          "doc_count": 0
        },
        {
          "key_as_string": "1992",
          "key": 694224000000,
          "doc_count": 0
        },
        {
          "key_as_string": "1993",
          "key": 725846400000,
          "doc_count": 0
        },
        {
          "key_as_string": "1994",
          "key": 757382400000,
          "doc_count": 1
        }
      ]
    }
  }
}
```

## Bucket + Metric 聚合分析

Bucket 聚合分析允许通过添加子分析来进一步进行分析，该子分析可以是 Bucket ,也可以是 Metric。这也使得es的聚合分析能力变得异常强大

### 分桶之后再分桶

- request

```
GET test_search_index/_search
{
  "size": 0,
  "aggs": {
    "jobs": {
      "terms": {
        "field": "job.keyword",
        "size": 10
      },
      "aggs": {
        "age_range": {
          "range": {
            "field": "age",
            "ranges": [
              {
                "to": 20
              },
              {
                "from": 20,
                "to": 30
              },
              {
                "from": 30
              }
            ]
          }
        }
      }
    }
  }
}
```

- response

```
{
  "took": 1,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": 6,
    "max_score": 0,
    "hits": []
  },
  "aggregations": {
    "jobs": {
      "doc_count_error_upper_bound": 0,
      "sum_other_doc_count": 0,
      "buckets": [
        {
          "key": "ruby engineer",
          "doc_count": 2,
          "age_range": {
            "buckets": [
              {
                "key": "*-20.0",
                "to": 20,
                "doc_count": 0
              },
              {
                "key": "20.0-30.0",
                "from": 20,
                "to": 30,
                "doc_count": 2
              },
              {
                "key": "30.0-*",
                "from": 30,
                "doc_count": 0
              }
            ]
          }
        },
        {
          "key": "web engineer",
          "doc_count": 2,
          "age_range": {
            "buckets": [
              {
                "key": "*-20.0",
                "to": 20,
                "doc_count": 1
              },
              {
                "key": "20.0-30.0",
                "from": 20,
                "to": 30,
                "doc_count": 1
              },
              {
                "key": "30.0-*",
                "from": 30,
                "doc_count": 0
              }
            ]
          }
        },
        {
          "key": "java engineer",
          "doc_count": 1,
          "age_range": {
            "buckets": [
              {
                "key": "*-20.0",
                "to": 20,
                "doc_count": 1
              },
              {
                "key": "20.0-30.0",
                "from": 20,
                "to": 30,
                "doc_count": 0
              },
              {
                "key": "30.0-*",
                "from": 30,
                "doc_count": 0
              }
            ]
          }
        },
        {
          "key": "java senior engineer",
          "doc_count": 1,
          "age_range": {
            "buckets": [
              {
                "key": "*-20.0",
                "to": 20,
                "doc_count": 0
              },
              {
                "key": "20.0-30.0",
                "from": 20,
                "to": 30,
                "doc_count": 1
              },
              {
                "key": "30.0-*",
                "from": 30,
                "doc_count": 0
              }
            ]
          }
        }
      ]
    }
  }
}
```

### 分桶之后进行数据分析

- request

```
GET test_search_index/_search
{
  "size": 0,
  "aggs": {
    "jobs": {
      "terms": {
        "field": "job.keyword",
        "size": 10
      },
      "aggs": {
        "salary": {
          "stats": {
            "field": "salary"
          }
        }
      }
    }
  }
}
```

- response

```
{
  "took": 3,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": 6,
    "max_score": 0,
    "hits": []
  },
  "aggregations": {
    "jobs": {
      "doc_count_error_upper_bound": 0,
      "sum_other_doc_count": 0,
      "buckets": [
        {
          "key": "ruby engineer",
          "doc_count": 2,
          "salary": {
            "count": 2,
            "min": 12000,
            "max": 15000,
            "avg": 13500,
            "sum": 27000
          }
        },
        {
          "key": "web engineer",
          "doc_count": 2,
          "salary": {
            "count": 2,
            "min": 5000,
            "max": 8000,
            "avg": 6500,
            "sum": 13000
          }
        },
        {
          "key": "java engineer",
          "doc_count": 1,
          "salary": {
            "count": 1,
            "min": 10000,
            "max": 10000,
            "avg": 10000,
            "sum": 10000
          }
        },
        {
          "key": "java senior engineer",
          "doc_count": 1,
          "salary": {
            "count": 1,
            "min": 30000,
            "max": 30000,
            "avg": 30000,
            "sum": 30000
          }
        }
      ]
    }
  }
}
```

## Pipeline 聚合分析

针对聚合分析的结果再次进行聚合分析，而且支持链式调用

    - 订单月平均销售额是多少？

    首先将一年每个月的销售额拿到，然后将每个月的销售额相加除以12就得到月平均销售额

- request

```
GET test_search_index/_search
{
  "size": 0,
  "aggs": {
    "sales_per_month": {
      "date_histogram": {
        "field": "date",
        "interval": "month"
      },
      "aggs": {
        "sales": {
          "sum": {
            "field": "price"
          }
        }
      }
    },
    "avg_monthly_sales": {
      "avg_bucket": {
        "buckets_path": "sales_per_month>sales"
      }
    }
  }
}
```

- response

```
{
  "took": 5,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": 6,
    "max_score": 0,
    "hits": []
  },
  "aggregations": {
    "sales_per_month": {
      "buckets": []
    },
    "avg_monthly_sales": {
      "value": null
    }
  }
}
```

Pipeline 分析结果会输出到原结果中，根据输出位置的不同，分为以下两类：

1. Parent 结果内嵌到现有的聚合分析结果中
    
    - Derivative 求导 导数

    - Moving Average 移动平均

    - Cumulative Sum 累计求和

2. Sliling 结果有现有聚合分析结果同级

    - Max/Min/Avg/Sum Bucket

    - Stats/Extended Stats Bucket

    - Percentiles Bucket


### Sibling - Min Bucket

找出所有 Bucket 中值最小的 Bucket 名称和值

- request

```
GET test_search_index/_search
{
  "size": 0,
  "aggs": {
    "jobs": {
      "terms": {
        "field": "job.keyword",
        "size": 10
      },
      "aggs": {
        "avg_salary": {
          "avg": {
            "field": "salary"
          }
        }
      }
    },
    "min_salary_by_job": {
      "min_bucket": {
        "buckets_path": "jobs>avg_salary"
      }
    }
  }
}
```

jobs: 首先根据 jobs 进行分桶

avg_salary: 然后对每个分桶做指标分析，求salary的平均值，平均工资

比如现在想要知道工资最低的工作类型是什么

min_salary_by_job: 和jobs同级，是对 jobs 的结果再次进行聚合分析，分析的是jobs下面的avg_salary，根据结果返回知道工资最低的是 web engineer

- response

```
{
  "took": 3,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": 6,
    "max_score": 0,
    "hits": []
  },
  "aggregations": {
    "jobs": {
      "doc_count_error_upper_bound": 0,
      "sum_other_doc_count": 0,
      "buckets": [
        {
          "key": "ruby engineer",
          "doc_count": 2,
          "avg_salary": {
            "value": 13500
          }
        },
        {
          "key": "web engineer",
          "doc_count": 2,
          "avg_salary": {
            "value": 6500
          }
        },
        {
          "key": "java engineer",
          "doc_count": 1,
          "avg_salary": {
            "value": 10000
          }
        },
        {
          "key": "java senior engineer",
          "doc_count": 1,
          "avg_salary": {
            "value": 30000
          }
        }
      ]
    },
    "min_salary_by_job": {
      "value": 6500,
      "keys": [
        "web engineer"
      ]
    }
  }
}
```

### Sibling - Max Bucket

找出所有 Bucket 中值最大的 Bucket 名称和值

- request

```
GET test_search_index/_search
{
  "size": 0,
  "aggs": {
    "jobs": {
      "terms": {
        "field": "job.keyword",
        "size": 10
      },
      "aggs": {
        "avg_salary": {
          "avg": {
            "field": "salary"
          }
        }
      }
    },
    "max_salary_by_job": {
      "max_bucket": {
        "buckets_path": "jobs>avg_salary"
      }
    }
  }
}
```

- response

```
{
  "took": 0,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": 6,
    "max_score": 0,
    "hits": []
  },
  "aggregations": {
    "jobs": {
      "doc_count_error_upper_bound": 0,
      "sum_other_doc_count": 0,
      "buckets": [
        {
          "key": "ruby engineer",
          "doc_count": 2,
          "avg_salary": {
            "value": 13500
          }
        },
        {
          "key": "web engineer",
          "doc_count": 2,
          "avg_salary": {
            "value": 6500
          }
        },
        {
          "key": "java engineer",
          "doc_count": 1,
          "avg_salary": {
            "value": 10000
          }
        },
        {
          "key": "java senior engineer",
          "doc_count": 1,
          "avg_salary": {
            "value": 30000
          }
        }
      ]
    },
    "max_salary_by_job": {
      "value": 30000,
      "keys": [
        "java senior engineer"
      ]
    }
  }
}
```

### Sibling - Avg Bucket

计算所有 Bucket 的平均值

- reqeust

```
GET test_search_index/_search
{
  "size": 0,
  "aggs": {
    "jobs": {
      "terms": {
        "field": "job.keyword",
        "size": 10
      },
      "aggs": {
        "avg_salary": {
          "avg": {
            "field": "salary"
          }
        }
      }
    },
    "avg_salary_by_job": {
      "avg_bucket": {
        "buckets_path": "jobs>avg_salary"
      }
    }
  }
}
```

- response

```
{
  "took": 0,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": 6,
    "max_score": 0,
    "hits": []
  },
  "aggregations": {
    "jobs": {
      "doc_count_error_upper_bound": 0,
      "sum_other_doc_count": 0,
      "buckets": [
        {
          "key": "ruby engineer",
          "doc_count": 2,
          "avg_salary": {
            "value": 13500
          }
        },
        {
          "key": "web engineer",
          "doc_count": 2,
          "avg_salary": {
            "value": 6500
          }
        },
        {
          "key": "java engineer",
          "doc_count": 1,
          "avg_salary": {
            "value": 10000
          }
        },
        {
          "key": "java senior engineer",
          "doc_count": 1,
          "avg_salary": {
            "value": 30000
          }
        }
      ]
    },
    "avg_salary_by_job": {
      "value": 15000
    }
  }
}
```

### Sibling - Sum Bucket

计算所有 Bucket 值的总和

- request

```
GET test_search_index/_search
{
  "size": 0,
  "aggs": {
    "jobs": {
      "terms": {
        "field": "job.keyword",
        "size": 10
      },
      "aggs": {
        "avg_salary": {
          "avg": {
            "field": "salary"
          }
        }
      }
    },
    "sum_salary_by_job": {
      "sum_bucket": {
        "buckets_path": "jobs>avg_salary"
      }
    }
  }
}
```

- response

```
{
  "took": 0,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": 6,
    "max_score": 0,
    "hits": []
  },
  "aggregations": {
    "jobs": {
      "doc_count_error_upper_bound": 0,
      "sum_other_doc_count": 0,
      "buckets": [
        {
          "key": "ruby engineer",
          "doc_count": 2,
          "avg_salary": {
            "value": 13500
          }
        },
        {
          "key": "web engineer",
          "doc_count": 2,
          "avg_salary": {
            "value": 6500
          }
        },
        {
          "key": "java engineer",
          "doc_count": 1,
          "avg_salary": {
            "value": 10000
          }
        },
        {
          "key": "java senior engineer",
          "doc_count": 1,
          "avg_salary": {
            "value": 30000
          }
        }
      ]
    },
    "sum_salary_by_job": {
      "value": 60000
    }
  }
}
``` 

### Sibling - Stats Bucket

计算所有 Bucket 值的 Stats 分析

- request

```
GET test_search_index/_search
{
  "size": 0,
  "aggs": {
    "jobs": {
      "terms": {
        "field": "job.keyword",
        "size": 10
      },
      "aggs": {
        "avg_salary": {
          "avg": {
            "field": "salary"
          }
        }
      }
    },
    "stats_salary_by_job": {
      "stats_bucket": {
        "buckets_path": "jobs>avg_salary"
      }
    }
  }
}
```

- response

```
{
  "took": 0,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": 6,
    "max_score": 0,
    "hits": []
  },
  "aggregations": {
    "jobs": {
      "doc_count_error_upper_bound": 0,
      "sum_other_doc_count": 0,
      "buckets": [
        {
          "key": "ruby engineer",
          "doc_count": 2,
          "avg_salary": {
            "value": 13500
          }
        },
        {
          "key": "web engineer",
          "doc_count": 2,
          "avg_salary": {
            "value": 6500
          }
        },
        {
          "key": "java engineer",
          "doc_count": 1,
          "avg_salary": {
            "value": 10000
          }
        },
        {
          "key": "java senior engineer",
          "doc_count": 1,
          "avg_salary": {
            "value": 30000
          }
        }
      ]
    },
    "stats_salary_by_job": {
      "count": 4,
      "min": 6500,
      "max": 30000,
      "avg": 15000,
      "sum": 60000
    }
  }
}
```

### Sibling - Percentiles Bucket

计算所有 Bucket 值的百分数

- request

```
GET test_search_index/_search
{
  "size": 0,
  "aggs": {
    "jobs": {
      "terms": {
        "field": "job.keyword",
        "size": 10
      },
      "aggs": {
        "avg_salary": {
          "avg": {
            "field": "salary"
          }
        }
      }
    },
    "percentiles_salary_by_job": {
      "percentiles_bucket": {
        "buckets_path": "jobs>avg_salary"
      }
    }
  }
}
```

- response

```
{
  "took": 0,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": 6,
    "max_score": 0,
    "hits": []
  },
  "aggregations": {
    "jobs": {
      "doc_count_error_upper_bound": 0,
      "sum_other_doc_count": 0,
      "buckets": [
        {
          "key": "ruby engineer",
          "doc_count": 2,
          "avg_salary": {
            "value": 13500
          }
        },
        {
          "key": "web engineer",
          "doc_count": 2,
          "avg_salary": {
            "value": 6500
          }
        },
        {
          "key": "java engineer",
          "doc_count": 1,
          "avg_salary": {
            "value": 10000
          }
        },
        {
          "key": "java senior engineer",
          "doc_count": 1,
          "avg_salary": {
            "value": 30000
          }
        }
      ]
    },
    "percentiles_salary_by_job": {
      "values": {
        "1.0": 6500,
        "5.0": 6500,
        "25.0": 10000,
        "50.0": 13500,
        "75.0": 13500,
        "95.0": 30000,
        "99.0": 30000
      }
    }
  }
}
```

### Parent - Derivative

计算 Bucket 值的导数

- request

```
GET test_search_index/_search
{
  "size": 0,
  "aggs": {
    "birth": {
      "date_histogram": {
        "field": "birth",
        "interval": "year",
        "min_doc_count": 0
      },
      "aggs": {
        "avg_salary": {
          "avg": {
            "field": "salary"
          }
        },
        "derivative_avg_salary": {
          "derivative": {
            "buckets_path": "avg_salary"
          }
        }
      }
    }
  }
}
```

derivative_avg_salary 和 avg_salary 同级，Parent Pipeline 是跟要分析的指标是同一个级别的

- resposne

```
{
  "took": 3,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": 6,
    "max_score": 0,
    "hits": []
  },
  "aggregations": {
    "birth": {
      "buckets": [
        {
          "key_as_string": "1980-01-01T00:00:00.000Z",
          "key": 315532800000,
          "doc_count": 1,
          "avg_salary": {
            "value": 30000
          }
        },
        {
          "key_as_string": "1981-01-01T00:00:00.000Z",
          "key": 347155200000,
          "doc_count": 0,
          "avg_salary": {
            "value": null
          },
          "derivative_avg_salary": {
            "value": null
          }
        },
        {
          "key_as_string": "1982-01-01T00:00:00.000Z",
          "key": 378691200000,
          "doc_count": 0,
          "avg_salary": {
            "value": null
          },
          "derivative_avg_salary": {
            "value": null
          }
        },
        {
          "key_as_string": "1983-01-01T00:00:00.000Z",
          "key": 410227200000,
          "doc_count": 0,
          "avg_salary": {
            "value": null
          },
          "derivative_avg_salary": {
            "value": null
          }
        },
        {
          "key_as_string": "1984-01-01T00:00:00.000Z",
          "key": 441763200000,
          "doc_count": 0,
          "avg_salary": {
            "value": null
          },
          "derivative_avg_salary": {
            "value": null
          }
        },
        {
          "key_as_string": "1985-01-01T00:00:00.000Z",
          "key": 473385600000,
          "doc_count": 1,
          "avg_salary": {
            "value": 15000
          },
          "derivative_avg_salary": {
            "value": null
          }
        },
        {
          "key_as_string": "1986-01-01T00:00:00.000Z",
          "key": 504921600000,
          "doc_count": 0,
          "avg_salary": {
            "value": null
          },
          "derivative_avg_salary": {
            "value": null
          }
        },
        {
          "key_as_string": "1987-01-01T00:00:00.000Z",
          "key": 536457600000,
          "doc_count": 1,
          "avg_salary": {
            "value": 12000
          },
          "derivative_avg_salary": {
            "value": null
          }
        },
        {
          "key_as_string": "1988-01-01T00:00:00.000Z",
          "key": 567993600000,
          "doc_count": 0,
          "avg_salary": {
            "value": null
          },
          "derivative_avg_salary": {
            "value": null
          }
        },
        {
          "key_as_string": "1989-01-01T00:00:00.000Z",
          "key": 599616000000,
          "doc_count": 1,
          "avg_salary": {
            "value": 8000
          },
          "derivative_avg_salary": {
            "value": null
          }
        },
        {
          "key_as_string": "1990-01-01T00:00:00.000Z",
          "key": 631152000000,
          "doc_count": 1,
          "avg_salary": {
            "value": 10000
          },
          "derivative_avg_salary": {
            "value": 2000
          }
        },
        {
          "key_as_string": "1991-01-01T00:00:00.000Z",
          "key": 662688000000,
          "doc_count": 0,
          "avg_salary": {
            "value": null
          },
          "derivative_avg_salary": {
            "value": null
          }
        },
        {
          "key_as_string": "1992-01-01T00:00:00.000Z",
          "key": 694224000000,
          "doc_count": 0,
          "avg_salary": {
            "value": null
          },
          "derivative_avg_salary": {
            "value": null
          }
        },
        {
          "key_as_string": "1993-01-01T00:00:00.000Z",
          "key": 725846400000,
          "doc_count": 0,
          "avg_salary": {
            "value": null
          },
          "derivative_avg_salary": {
            "value": null
          }
        },
        {
          "key_as_string": "1994-01-01T00:00:00.000Z",
          "key": 757382400000,
          "doc_count": 1,
          "avg_salary": {
            "value": 5000
          },
          "derivative_avg_salary": {
            "value": null
          }
        }
      ]
    }
  }
}
```

### Parent - Moving Average

计算 Bucket 值的移动平均值,也就是可以看到数值的变化趋势

- request

```
GET test_search_index/_search
{
  "size": 0,
  "aggs": {
    "birth": {
      "date_histogram": {
        "field": "birth",
        "interval": "year",
        "min_doc_count": 0
      },
      "aggs": {
        "avg_salary": {
          "avg": {
            "field": "salary"
          }
        },
        "mavg_salary": {
          "moving_avg": {
            "buckets_path": "avg_salary"
          }
        }
      }
    }
  }
}
```

- response

```
{
  "took": 3,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": 6,
    "max_score": 0,
    "hits": []
  },
  "aggregations": {
    "birth": {
      "buckets": [
        {
          "key_as_string": "1980-01-01T00:00:00.000Z",
          "key": 315532800000,
          "doc_count": 1,
          "avg_salary": {
            "value": 30000
          }
        },
        {
          "key_as_string": "1981-01-01T00:00:00.000Z",
          "key": 347155200000,
          "doc_count": 0,
          "avg_salary": {
            "value": null
          }
        },
        {
          "key_as_string": "1982-01-01T00:00:00.000Z",
          "key": 378691200000,
          "doc_count": 0,
          "avg_salary": {
            "value": null
          }
        },
        {
          "key_as_string": "1983-01-01T00:00:00.000Z",
          "key": 410227200000,
          "doc_count": 0,
          "avg_salary": {
            "value": null
          }
        },
        {
          "key_as_string": "1984-01-01T00:00:00.000Z",
          "key": 441763200000,
          "doc_count": 0,
          "avg_salary": {
            "value": null
          }
        },
        {
          "key_as_string": "1985-01-01T00:00:00.000Z",
          "key": 473385600000,
          "doc_count": 1,
          "avg_salary": {
            "value": 15000
          },
          "mavg_salary": {
            "value": 30000
          }
        },
        {
          "key_as_string": "1986-01-01T00:00:00.000Z",
          "key": 504921600000,
          "doc_count": 0,
          "avg_salary": {
            "value": null
          }
        },
        {
          "key_as_string": "1987-01-01T00:00:00.000Z",
          "key": 536457600000,
          "doc_count": 1,
          "avg_salary": {
            "value": 12000
          },
          "mavg_salary": {
            "value": 22500
          }
        },
        {
          "key_as_string": "1988-01-01T00:00:00.000Z",
          "key": 567993600000,
          "doc_count": 0,
          "avg_salary": {
            "value": null
          }
        },
        {
          "key_as_string": "1989-01-01T00:00:00.000Z",
          "key": 599616000000,
          "doc_count": 1,
          "avg_salary": {
            "value": 8000
          },
          "mavg_salary": {
            "value": 19000
          }
        },
        {
          "key_as_string": "1990-01-01T00:00:00.000Z",
          "key": 631152000000,
          "doc_count": 1,
          "avg_salary": {
            "value": 10000
          },
          "mavg_salary": {
            "value": 16250
          }
        },
        {
          "key_as_string": "1991-01-01T00:00:00.000Z",
          "key": 662688000000,
          "doc_count": 0,
          "avg_salary": {
            "value": null
          }
        },
        {
          "key_as_string": "1992-01-01T00:00:00.000Z",
          "key": 694224000000,
          "doc_count": 0,
          "avg_salary": {
            "value": null
          }
        },
        {
          "key_as_string": "1993-01-01T00:00:00.000Z",
          "key": 725846400000,
          "doc_count": 0,
          "avg_salary": {
            "value": null
          }
        },
        {
          "key_as_string": "1994-01-01T00:00:00.000Z",
          "key": 757382400000,
          "doc_count": 1,
          "avg_salary": {
            "value": 5000
          },
          "mavg_salary": {
            "value": 15000
          }
        }
      ]
    }
  }
}
```

### Parent - Cumulative Sum

计算 Bucket 值的累积加和

- request

```
GET test_search_index/_search
{
  "size": 0,
  "aggs": {
    "birth": {
      "date_histogram": {
        "field": "birth",
        "interval": "year",
        "min_doc_count": 0
      },
      "aggs": {
        "avg_salary": {
          "avg": {
            "field": "salary"
          }
        },
        "cumulative_salary": {
          "cumulative_sum": {
            "buckets_path": "avg_salary"
          }
        }
      }
    }
  }
}
```

- response

```
{
  "took": 1,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": 6,
    "max_score": 0,
    "hits": []
  },
  "aggregations": {
    "birth": {
      "buckets": [
        {
          "key_as_string": "1980-01-01T00:00:00.000Z",
          "key": 315532800000,
          "doc_count": 1,
          "avg_salary": {
            "value": 30000
          },
          "cumulative_salary": {
            "value": 30000
          }
        },
        {
          "key_as_string": "1981-01-01T00:00:00.000Z",
          "key": 347155200000,
          "doc_count": 0,
          "avg_salary": {
            "value": null
          },
          "cumulative_salary": {
            "value": 30000
          }
        },
        {
          "key_as_string": "1982-01-01T00:00:00.000Z",
          "key": 378691200000,
          "doc_count": 0,
          "avg_salary": {
            "value": null
          },
          "cumulative_salary": {
            "value": 30000
          }
        },
        {
          "key_as_string": "1983-01-01T00:00:00.000Z",
          "key": 410227200000,
          "doc_count": 0,
          "avg_salary": {
            "value": null
          },
          "cumulative_salary": {
            "value": 30000
          }
        },
        {
          "key_as_string": "1984-01-01T00:00:00.000Z",
          "key": 441763200000,
          "doc_count": 0,
          "avg_salary": {
            "value": null
          },
          "cumulative_salary": {
            "value": 30000
          }
        },
        {
          "key_as_string": "1985-01-01T00:00:00.000Z",
          "key": 473385600000,
          "doc_count": 1,
          "avg_salary": {
            "value": 15000
          },
          "cumulative_salary": {
            "value": 45000
          }
        },
        {
          "key_as_string": "1986-01-01T00:00:00.000Z",
          "key": 504921600000,
          "doc_count": 0,
          "avg_salary": {
            "value": null
          },
          "cumulative_salary": {
            "value": 45000
          }
        },
        {
          "key_as_string": "1987-01-01T00:00:00.000Z",
          "key": 536457600000,
          "doc_count": 1,
          "avg_salary": {
            "value": 12000
          },
          "cumulative_salary": {
            "value": 57000
          }
        },
        {
          "key_as_string": "1988-01-01T00:00:00.000Z",
          "key": 567993600000,
          "doc_count": 0,
          "avg_salary": {
            "value": null
          },
          "cumulative_salary": {
            "value": 57000
          }
        },
        {
          "key_as_string": "1989-01-01T00:00:00.000Z",
          "key": 599616000000,
          "doc_count": 1,
          "avg_salary": {
            "value": 8000
          },
          "cumulative_salary": {
            "value": 65000
          }
        },
        {
          "key_as_string": "1990-01-01T00:00:00.000Z",
          "key": 631152000000,
          "doc_count": 1,
          "avg_salary": {
            "value": 10000
          },
          "cumulative_salary": {
            "value": 75000
          }
        },
        {
          "key_as_string": "1991-01-01T00:00:00.000Z",
          "key": 662688000000,
          "doc_count": 0,
          "avg_salary": {
            "value": null
          },
          "cumulative_salary": {
            "value": 75000
          }
        },
        {
          "key_as_string": "1992-01-01T00:00:00.000Z",
          "key": 694224000000,
          "doc_count": 0,
          "avg_salary": {
            "value": null
          },
          "cumulative_salary": {
            "value": 75000
          }
        },
        {
          "key_as_string": "1993-01-01T00:00:00.000Z",
          "key": 725846400000,
          "doc_count": 0,
          "avg_salary": {
            "value": null
          },
          "cumulative_salary": {
            "value": 75000
          }
        },
        {
          "key_as_string": "1994-01-01T00:00:00.000Z",
          "key": 757382400000,
          "doc_count": 1,
          "avg_salary": {
            "value": 5000
          },
          "cumulative_salary": {
            "value": 80000
          }
        }
      ]
    }
  }
}
```

## 作用范围

es聚合分析默认作用范围是 query 的结果集，可以通过下面方式改变其作用范围

    - filter

    - post_filter

    - global

```
GET test_search_index/_search
{
  "size": 0,
  "query": {
    "match": {
      "username": "alfred"
    }
  },
  "aggs": {
    "jobs": {
      "terms": {
        "field": "job.keyword",
        "size": 10
      }
    }
  }
}
```

这边限定的查询条件是 username 是 alfred 的，在做聚合分析的时候直接分析复合查询条件的文档，除了 query ,es还提供了三种方式来改变聚合分析的作用范围

es 的聚合分析默认的是作用范围是 query 的结果集，aggs是和 query 同级的，也就意味着 aggs 是受 query的影响的

### filter

为某个聚合分析设定过滤条件，从而在不更改整体 query 语句的情况下修改了作用范围

- request

```
GET test_search_index/_search
{
  "size": 0,
  "aggs": {
    "jobs_salary_small": {
      "filter": {
        "range": {
          "salary": {
            "lte": 20
          }
        }
      },
      "aggs": {
        "jobs": {
          "terms": {
            "field": "job.keyword",
            "size": 10
          }
        }
      }
    },
    "jobs": {
      "terms": {
        "field": "job.keyword",
        "size": 10
      }
    }
  }
}
```

- response

```
{
  "took": 0,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": 6,
    "max_score": 0,
    "hits": []
  },
  "aggregations": {
    "jobs_salary_small": {
      "doc_count": 0,
      "jobs": {
        "doc_count_error_upper_bound": 0,
        "sum_other_doc_count": 0,
        "buckets": []
      }
    },
    "jobs": {
      "doc_count_error_upper_bound": 0,
      "sum_other_doc_count": 0,
      "buckets": [
        {
          "key": "ruby engineer",
          "doc_count": 2
        },
        {
          "key": "web engineer",
          "doc_count": 2
        },
        {
          "key": "java engineer",
          "doc_count": 1
        },
        {
          "key": "java senior engineer",
          "doc_count": 1
        }
      ]
    }
  }
}
```

### post-filter

作用于文档过滤，但是聚合分析后生效,不是改变聚合分析作用范围，食杂聚合分析之后再去过滤文档

- request

```
GET test_search_index/_search
{
  "aggs": {
    "jobs": {
      "terms": {
        "field": "job.keyword",
        "size": 10
      }
    }
  },
  "post_filter": {
    "match": {
      "job.keyword": "java engineer"
    }
  }
}
```

聚合分析还是针对所有文档做聚合分析，然后经过post_filter过滤实际返回中的文档只有 java engineer

- response

```
{
  "took": 1,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": 1,
    "max_score": 1,
    "hits": [
      {
        "_index": "test_search_index",
        "_type": "doc",
        "_id": "1",
        "_score": 1,
        "_source": {
          "username": "alfred way",
          "job": "java engineer",
          "age": 18,
          "birth": "1990-01-02",
          "isMarried": false,
          "salary": 10000
        }
      }
    ]
  },
  "aggregations": {
    "jobs": {
      "doc_count_error_upper_bound": 0,
      "sum_other_doc_count": 0,
      "buckets": [
        {
          "key": "ruby engineer",
          "doc_count": 2
        },
        {
          "key": "web engineer",
          "doc_count": 2
        },
        {
          "key": "java engineer",
          "doc_count": 1
        },
        {
          "key": "java senior engineer",
          "doc_count": 1
        }
      ]
    }
  }
}
```

### global

无视 query 过滤条件，基于全部温昂进行分析

- request

```
GET test_search_index/_search
{
  "query": {
    "match": {
      "job.keyword": "java engineer"
    }
  },
  "aggs": {
    "java_avg_salary": {
      "avg": {
        "field": "salary"
      }
    },
    "all": {
      "global": {},
      "aggs": {
        "avg_salary": {
          "avg": {
            "field": "salary"
          }
        }
      }
    }
  }
}
```

- response

```
{
  "took": 2,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": 1,
    "max_score": 1.5404451,
    "hits": [
      {
        "_index": "test_search_index",
        "_type": "doc",
        "_id": "1",
        "_score": 1.5404451,
        "_source": {
          "username": "alfred way",
          "job": "java engineer",
          "age": 18,
          "birth": "1990-01-02",
          "isMarried": false,
          "salary": 10000
        }
      }
    ]
  },
  "aggregations": {
    "all": {
      "doc_count": 6,
      "avg_salary": {
        "value": 13333.333333333334
      }
    },
    "java_avg_salary": {
      "value": 10000
    }
  }
}
```

## 排序

聚合分析中的排序可以是用自带关键数据进行排序,如果不指定order，默认按照 count 倒排

    - _count 文档数,按照分桶数数据排序

    - _key 按照 key 值排序 

- request

```
GET test_search_index/_search
{
  "size": 0,
  "aggs": {
    "jobs": {
      "terms": {
        "field": "job.keyword",
        "size": 10,
        "order": [
          {
            "_count": "asc"
          },
          {
            "_key": "desc"
          }
        ]
      }
    }
  }
}
```

- response

```
{
  "took": 8,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": 6,
    "max_score": 0,
    "hits": []
  },
  "aggregations": {
    "jobs": {
      "doc_count_error_upper_bound": 0,
      "sum_other_doc_count": 0,
      "buckets": [
        {
          "key": "java senior engineer",
          "doc_count": 1
        },
        {
          "key": "java engineer",
          "doc_count": 1
        },
        {
          "key": "web engineer",
          "doc_count": 2
        },
        {
          "key": "ruby engineer",
          "doc_count": 2
        }
      ]
    }
  }
}
```

### 根据子聚合分析排序

#### 单值

- request

```
GET test_search_index/_search
{
  "size": 0,
  "aggs": {
    "jobs": {
      "terms": {
        "field": "job.keyword",
        "size": 10,
        "order": [
          {
            "avg_salary": "desc"
          }
        ]
      },
      "aggs": {
        "avg_salary": {
          "avg": {
            "field": "salary"
          }
        }
      }
    }
  }
}
```

按照 job.keyword 分桶，子聚合分析根据工资做平均值计算，order 排序是根据平均工资倒排

- response

```
{
  "took": 0,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": 6,
    "max_score": 0,
    "hits": []
  },
  "aggregations": {
    "jobs": {
      "doc_count_error_upper_bound": 0,
      "sum_other_doc_count": 0,
      "buckets": [
        {
          "key": "java senior engineer",
          "doc_count": 1,
          "avg_salary": {
            "value": 30000
          }
        },
        {
          "key": "ruby engineer",
          "doc_count": 2,
          "avg_salary": {
            "value": 13500
          }
        },
        {
          "key": "java engineer",
          "doc_count": 1,
          "avg_salary": {
            "value": 10000
          }
        },
        {
          "key": "web engineer",
          "doc_count": 2,
          "avg_salary": {
            "value": 6500
          }
        }
      ]
    }
  }
}
```

#### 多值

- reqeust

```
GET test_search_index/_search
{
  "size": 0,
  "aggs": {
    "jobs": {
      "terms": {
        "field": "job.keyword",
        "size": 10,
        "order": [
          {
            "stats_salary.sum": "desc"
          }
        ]
      },
      "aggs": {
        "stats_salary": {
          "stats": {
            "field": "salary"
          }
        }
      }
    }
  }
}  
```

- response

```
{
  "took": 0,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": 6,
    "max_score": 0,
    "hits": []
  },
  "aggregations": {
    "jobs": {
      "doc_count_error_upper_bound": 0,
      "sum_other_doc_count": 0,
      "buckets": [
        {
          "key": "java senior engineer",
          "doc_count": 1,
          "stats_salary": {
            "count": 1,
            "min": 30000,
            "max": 30000,
            "avg": 30000,
            "sum": 30000
          }
        },
        {
          "key": "ruby engineer",
          "doc_count": 2,
          "stats_salary": {
            "count": 2,
            "min": 12000,
            "max": 15000,
            "avg": 13500,
            "sum": 27000
          }
        },
        {
          "key": "web engineer",
          "doc_count": 2,
          "stats_salary": {
            "count": 2,
            "min": 5000,
            "max": 8000,
            "avg": 6500,
            "sum": 13000
          }
        },
        {
          "key": "java engineer",
          "doc_count": 1,
          "stats_salary": {
            "count": 1,
            "min": 10000,
            "max": 10000,
            "avg": 10000,
            "sum": 10000
          }
        }
      ]
    }
  }
}
```

- request

```
GET test_search_index/_search
{
  "size": 0,
  "aggs": {
    "salary_hist": {
      "histogram": {
        "field": "salary",
        "interval": 5000,
        "order": {
          "age>avg_age": "asc"
        }
      },
      "aggs": {
        "age": {
          "filter": {
            "range": {
              "age": {
                "gte": 10
              }
            }
          },
          "aggs": {
            "avg_age": {
              "avg": {
                "field": "age"
              }
            }
          }
        }
      }
    }
  }
}
```

比如引用的值是 json object 的值就需要使用 `>`,上面应用的是 json object 里面的值就需要使用 `.`

- response

```
{
  "took": 2,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": 6,
    "max_score": 0,
    "hits": []
  },
  "aggregations": {
    "salary_hist": {
      "buckets": [
        {
          "key": 5000,
          "doc_count": 2,
          "age": {
            "doc_count": 2,
            "avg_age": {
              "value": 20.5
            }
          }
        },
        {
          "key": 10000,
          "doc_count": 2,
          "age": {
            "doc_count": 2,
            "avg_age": {
              "value": 22
            }
          }
        },
        {
          "key": 15000,
          "doc_count": 1,
          "age": {
            "doc_count": 1,
            "avg_age": {
              "value": 22
            }
          }
        },
        {
          "key": 30000,
          "doc_count": 1,
          "age": {
            "doc_count": 1,
            "avg_age": {
              "value": 28
            }
          }
        },
        {
          "key": 20000,
          "doc_count": 0,
          "age": {
            "doc_count": 0,
            "avg_age": {
              "value": null
            }
          }
        },
        {
          "key": 25000,
          "doc_count": 0,
          "age": {
            "doc_count": 0,
            "avg_age": {
              "value": null
            }
          }
        }
      ]
    }
  }
}
```

## 原理与计算精准度问题

比如 Min 聚合的执行流程

```
GET test_search_index/_search
{
    "size": 0,
    "aggs": {
        "min_age": {
            "min": {
                "field": "age"
            }
        }
    }
}
```

假设哟5个分片，p0,p1,p2,p3,p4,es接收到查询语句之后 Coordinating Node 会到每个分片上去获取最小的age的值，然后再从获取到的5个分片上的最小值中取最小值

比如 Terms 聚合的执行流程

```
GET test_search_index/_search
{
    "size": 0,
    "aggs": {
        "jobs": {
            "terms": {
                "field": "job.keyword",
                "size": 5
            }
        }
    }
}
```

es 接收到查询语句之后，Coordinating Node 会根据每个分片取出top 5的工作类型，Coordinating Node 拿到这些数据之后做一个整合，然后做个排序，然后返回整合之后top 5的数据返回给用户

这种情况执行的时候会出现一个问题，所以 Terms 执行的并不是永远准确的，比如现在有 p0, p1 两个 Shard,在 p0 上有4个数据分别是 a(5), b(4), c(3), d(4) ，a有5个文档，b有4个文档，c有3个文档，d有4个文档，p1上也有4个数据 a(5), b(2), c(3), d(1)，比如此时有个查询条件返回 Top 3 的数据，p0会返回a(5),b(4),d(4)，p1会返回a(5),c(3),b(2)，Coordinating Node 拿到这些数据之后做一次整合变成 a(10),b(6),d(4)，而原始数据c每个shard上都是3，加起来是6，真正的结果应该是 a,b,c,原因是 p0 在返回 top3 的时候c是没有返回的，这个例子就是展示 terms 计算并不是准确的，这里面就存在精准度的问题

### Terms 不准确的原因

数据分散在多个 Shard 上，Coordinating Node 无法得悉数据全貌，所以就会导致 Terms 不会永远精准

### Terms 不准确的解决办法

1. 设置 Shard 数为1，消除数据分散的问题，但无法承载大数据量，比如数量很小，百万级，千万级的时候，在查询容忍度之内可以把shard设置成1

2. 合理设置 Shard_Size 大小，即每次从 Shard 上额外多获取数据，以提升精准度

```
GET test_search_index/_search
{
    "size": 0,
    "aggs": {
        "jobs": {
            "terms": {
                "field": "job.keyword",
                "size": 1,
                "shard_size": 10
            }
        }
    }
}
```

shard_size 就是 Coordinating Node 从每个 shard 上取多少个数据，比如刚才指定 top 3,但是 Coordinating Node 取的时候可以取4个，取5个，想上面的举例数据，如果取四个数据的话结果就是准确的

### Shard_Size 大小的设定方法

terms 聚合返回结果中有如下两个统计值，可以通多这些参数设置Shard_Size大小

    - doc_count_error_upper_bound 被遗漏的 term 可能的最大值

    - sum_other_doc_count 返回结果 bucket 的 term 外其他 term 的文档总数

比如现在有 p0, p1 两个 Shard,在 p0 上有4个数据分别是 a(5), b(4), c(3), d(4) ，a有5个文档，b有4个文档，c有3个文档，d有4个文档，p1上也有4个数据 a(5), b(2), c(3), d(1)，比如此时有个查询条件返回 Top 3 的数据，p0会返回a(5),b(4),d(4)，p1会返回a(5),c(3),b(2)

如果有一个文档时应该返回的，但是由于取的是TOP N 的数据，这个文档可能没有在Shard返回的列表里面，这个term返回的最有可能的最大值就是返回的列表里面的最小值，比如p0,c并没有在返回的列表里面，那么c的最大值就是4，即c(4),p1同理有个d没有返回，那么d可能的最大值是2,即d(2),然后将shard里面返回的最小值加起来就是可能被遗漏的最大文档数是4+2=6，所以 doc_count_error_upper_bound:6

sum_other_doc_count 除了返回结果之外的文档总数，因为返回的结果是 a(10),b(6),d(4),返回之外的就是 c,c 有6个，那么 sum_other_doc_count:6,也可以理解成总文档数减去返回结果的的总文档数

可以设定 `show_term_doc_count_error` 查看每个 bucket 误算的最大值

```
GET test_search_index/_search
{
    "size": 0,
    "aggs": {
        "jobs": {
            "terms": {
                "field": "job.keyword",
                "size": 2，
                "show_term_doc_count_error": true
            }
        }
    }
}
```

那么返回的结果里面就会多一个字段就是  `show_term_doc_count_error`,如果结果是0，就表示计算的结果是准确的

那么什么时候值为0呢？就是在每个shard都返回了key,都返回了term的时候就是0
还是上面的例子，返回的结果是  a(10),b(6),d(4),返回的时候p0里面是有d的，但是p1里面是没有d的，
此时就拿没有返回d的数据列表里面最小值加起来就是 doc_count_error_upper_bound 的值，这里如果只有p1没有返回，那就是2,所以term 的 doc_count_error_upper_bound 为 2

设定 Shard_Size 的原则就是确保 doc_count_error_upper_bound 是 0，尽量保证每一个 shard 都把文档返回，这样 Coordinating Node 做整合的时候计算就是最准的


* Shard_Size 大小如下

    - shard_size = (size * 1.5) + 10

通过调整 Shard_Size 的大小减低 doc_count_error_upper_bound 来提升准确度，doc_count_error_upper_bound 越小，结果越准，如果 shard_size 越大，就会增加整体的计算量，从而降低响应时间

    - 增大了整体的计算量，从而降低了响应时间

shard_size 调整实例

- request

```
GET test_search_index/_search
{
  "size": 0,
  "aggs": {
    "jobs": {
      "terms": {
        "field": "job.keyword",
        "size": 1,
        "shard_size": 10,
        "show_term_doc_count_error": true
      }
    }
  }
}
```

- response

```
{
  "took": 0,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": 6,
    "max_score": 0,
    "hits": []
  },
  "aggregations": {
    "jobs": {
      "doc_count_error_upper_bound": 0,
      "sum_other_doc_count": 4,
      "buckets": [
        {
          "key": "ruby engineer",
          "doc_count": 2,
          "doc_count_error_upper_bound": 0
        }
      ]
    }
  }
}
```

doc_count_error_upper_bound 值为 0，因为现在 test_search_index 的 shard 只有1个,就以为这所有的 terms 都会被返回

```
GET test_search_index
```

```
{
  "test_search_index": {
    ...
    "settings": {
      "index": {
        "creation_date": "1593095784891",
        "number_of_shards": "1",
        "number_of_replicas": "1",
        "uuid": "FVsoQZc4T2KV4UdJcSfefQ",
        "version": {
          "created": "6030299"
        },
        "provided_name": "test_search_index"
      }
    }
  }
}
```

### 近似统计算法

1. 海量数据

2. 实时性

3. 准确度

在做统计分析的时候希望能对海量数据做分析，而且实时性越高越好，最好能立刻返回，还有就是希望数据是准确的，如果不准确做分析就没有意义了

在实际应用中，可能三者都不能同时满足，需要做权衡，或者三者只能满足两个

如果要求准确度和海量数据，解决方案是 `Hadoop 离线计算`，缺点实时性差，可能要等几个小时或者几天

如果要求确定度和实时性，解决方案是 `有限数据计算`，限定数据规模，缺点是不支持海量数据

如果要求海量数据和实时性，解决方案是使用 `近似统计算法`,缺点是牺牲准确度，就是计算出来的数值不是绝对准确的

* 在es中的聚合分析中，Cardinality 和 Percentile 分析使用的是近似统计算法

    - 结果是近似准确，但不一定准确

    - 可以通过参数的调整使其结果精准，但同时也以为这更多的计算时间和更大的性能消耗，更大的消耗内存，也就以为这实时性会大打折扣

## Test Data

```
POST test_search_index/doc/_bulk
{"index":{"_id":"1"}}
{"username":"alfred way","job":"java engineer","age":18,"birth":"1990-01-02","isMarried":false,"salary":10000}
{"index":{"_id":"2"}}
{"username":"tom","job":"java senior engineer","age":28,"birth":"1980-05-07","isMarried":true,"salary":30000}
{"index":{"_id":"3"}}
{"username":"lee","job":"ruby engineer","age":22,"birth":"1985-08-07","isMarried":false,"salary":15000}
{"index":{"_id":"4"}}
{"username":"Nick","job":"web engineer","age":23,"birth":"1989-08-07","isMarried":false,"salary":8000}
{"index":{"_id":"5"}}
{"username":"Niko","job":"web engineer","age":18,"birth":"1994-08-07","isMarried":false,"salary":5000}
{"index":{"_id":"6"}}
{"username":"Michell","job":"ruby engineer","age":26,"birth":"1987-08-07","isMarried":false,"salary":12000}
```