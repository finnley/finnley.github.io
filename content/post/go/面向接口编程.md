+++
title = '面向接口编程'
date = 2025-08-28T14:57:26+08:00
draft = true
categories = [ "Go" ]
tags = [ "go", "IOP" ]
+++

## 改造

先改造底层的 cache，原始代码如下：
```go
package cache

type CodeCache struct {
	client redis.Cmdable
}

func NewCodeCache(client redis.Cmdable) *CodeCache {
	return &CodeCache{
		client: client,
	}
}

func (c *CodeCache) Set(ctx context.Context, biz, phone, code string) error {
}

func (c *CodeCache) Verify(ctx context.Context, biz, phone, inputCode string) (bool, error) {
}

func (c *CodeCache) key(biz, phone string) string {
}

```

1、先对 CodeCache 改名，表示这个Cache是基于Redis来实现的改名后如下：
```go
type RedisCodeCache struct {
	client redis.Cmdable
}

func NewCodeCache(client redis.Cmdable) *RedisCodeCache {
	return &RedisCodeCache{
		client: client,
	}
}

func (c *RedisCodeCache) Set(ctx context.Context, biz, phone, code string) error {
}

func (c *RedisCodeCache) Verify(ctx context.Context, biz, phone, inputCode string) (bool, error) {
}

func (c *RedisCodeCache) key(biz, phone string) string {
}

```

2、定义接口 

```go
type CodeCache interface {
	
}
```

3、将原有结构体上的方法的签名写入到接口中

```go
type CodeCache interface {
	Set(ctx context.Context, biz, phone, code string) error
	Verify(ctx context.Context, biz, phone, inputCode string) (bool, error)
}
```

4、需要注意的是New方法返回的不再是结构体，而是接口。

```go
func NewCodeCache(client redis.Cmdable) CodeCache {
	return &RedisCodeCache{
		client: client,
	}
}
```


凡是之前在结构体中组合的时候，如果引用的指针需要移除，在使用的地方也是如此，比如：

```go
type CacheCodeRepository struct {
	cache cache.CodeCache
}

func NewCodeRepository(c cache.CodeCache) CodeRepository {
	return &CacheCodeRepository{
		cache: c,
	}
}
```

到这里一个接口改造就完成了，简单吧。

