+++
title = 'é›†ç¾¤åˆå§‹åŒ–'
date = 2024-10-16T22:52:25+08:00
draft = false
categories = [ "Kubernetes" ]
tags = [ "k8s", "kubernetes" ]
+++

# æ–‡æ¡£

**å‚è€ƒ**
- [Installing kubeadm](https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/)
- [](https://kubernetes.io/docs/home/)

**ä»‹ç»**

k8sé›†ç¾¤ç¯å¢ƒæœ‰ä¸¤ç§ç±»å‹ï¼Œä¸€ç§æ˜¯å­¦ä¹ ç¯å¢ƒï¼Œä¸€ç§æ˜¯ç”Ÿäº§ç¯å¢ƒã€‚

- å­¦ä¹ ç¯å¢ƒï¼š[Learning environment](https://kubernetes.io/docs/setup/#learning-environment)
- ç”Ÿäº§ç¯å¢ƒï¼š[Bootstrapping clusters with kubeadm](https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/)

## å®‰è£…å·¥å…·

- kubectl
- kind
- minikube
- kubeadm

## ä¸»æœºé…ç½®

**ç¦ç”¨ Swap åˆ†åŒº**

ç¦ç”¨çš„åŸå› ï¼šå½“å†…å­˜ä¸å¤Ÿæ—¶ä¼šä½¿ç”¨ç£ç›˜æ¥ä»£æ›¿å†…å­˜ã€‚å†…å­˜å’Œç£ç›˜ä¸æ˜¯ç»Ÿä¸€è®¡ç®—ç­‰çº§ï¼Œç¦ç”¨æ‰å°±ä¸ä¼šå‡ºç°è®¡ç®—é€Ÿç‡ä¸ä¸€è‡´çš„é—®é¢˜ã€‚

1ã€ç¼–è¾‘ `/etc/fstab` æ–‡ä»¶ï¼Œæ³¨é‡Š `/swapfile ...` è¿™ä¸€è¡Œã€‚

2ã€é‡å¯

```bash
swapoff -a
```

**æ›¿æ¢ Docker cgroup**

ç¼–è¾‘ `/etc/docker/daemon.json`ï¼Œæ·»åŠ ä¸‹é¢å†…å®¹ï¼š
```bash
{
    ...
    "exec-opts": ["native.cgroupdriver=systemd"]
}
```

ä½¿ç”¨çš„æ˜¯ systemd è¿™ä¸€ cgroupï¼Œè¿™ä¹Ÿæ˜¯k8sæ¨èä½¿ç”¨çš„ cgroupã€‚

**é‡å¯**

```bash
systemctl daemon-reload && systemctl restart docker
```

**ç–‘é—®**

- cgroup æ˜¯ä»€ä¹ˆï¼Ÿ


# kind åˆå§‹åŒ–é›†ç¾¤ï¼ˆå­¦ä¹ ç¯å¢ƒï¼‰

**å‚è€ƒ**

- [kind](https://kind.sigs.k8s.io/)
- [kind quick-start](https://kind.sigs.k8s.io/docs/user/quick-start/)

**æ³¨æ„**

- è™½ç„¶ kind ä¸éœ€è¦ kubectl ï¼Œä½†æ˜¯æ²¡æœ‰ kubectl å°†æ— æ³•ä½¿ç”¨æ–‡æ¡£ä¸­çš„ä¸€äº›ç¤ºä¾‹ã€‚æ‰€ä»¥è¿˜æ˜¯å»ºè®®å®‰è£… kubectlã€‚

## å‡†å¤‡

**ç¯å¢ƒ**

| Resource | OS | Description |
| :--- | :---- | :---- |
| chaos-4 | Ubuntu20.04 LTS | Master |
| chaos-5 | Ubuntu20.04 LTS | Worker     |
| chaos-6 | Ubuntu20.04 LTS | Worker     |

**ç¡¬ä»¶**

| Resource | Minimum | Recommended |
| :--- | :---- | :---- |
| CPU | 2CPU | 4CPU |

**è½¯ä»¶**

| Resource | Description |
| :--- | :---- |
| kind | kindã€dockerã€ |
| Docker | kind æ˜¯ä»¥å®¹å™¨æ–¹å¼è¿è¡Œ kubenetes å®¹å™¨é›†ç¾¤çš„ï¼Œæ‰€ä»¥éœ€è¦Docker     |
| kubectl |  ä½¿ç”¨ kind æ–‡æ¡£ä¸­çš„ç¤ºä¾‹    |

**å¿«æ·å®‰è£… kubectl**
```bash
curl -LO https://dl.k8s.io/release/v1.31.0/bin/linux/amd64/kubectl
chmod +x kubectl
mv kubectl /usr/local/bin
```

**å¿«æ·å®‰è£… kind**
```bash
# For AMD64 / x86_64
[ $(uname -m) = x86_64 ] && curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.24.0/kind-linux-amd64
chmod +x ./kind
sudo mv ./kind /usr/local/bin/kind
```

## åˆå§‹åŒ–

**åˆå§‹åŒ–**

```bash
kind create cluster --name my-cluster
```

åˆå§‹åŒ–å¤±è´¥ï¼š
```bash
~# kind create cluster --name my-cluster
Creating cluster "my-cluster" ...
ERROR: failed to create cluster: failed to ensure docker network: command "docker network create -d=bridge -o com.docker.network.bridge.enable_ip_masquerade=true -o com.docker.network.driver.mtu=1500 --ipv6 --subnet fc00:f853:ccd:e793::/64 kind" failed with error: exit status 1
Command Output: Error response from daemon: Failed to Setup IP tables: Unable to enable NAT rule:  (iptables failed: ip6tables --wait -t nat -I POSTROUTING -s fc00:f853:ccd:e793::/64 ! -o br-eb21611dec54 -j MASQUERADE: ip6tables v1.8.4 (legacy): can't initialize ip6tables table `nat': Table does not exist (do you need to insmod?)
Perhaps ip6tables or your kernel needs to be upgraded.
 (exit status 3))
```

é™çº§ kind ç‰ˆæœ¬è‡³ `v0.19.0`ï¼Œç„¶åå†é‡æ–°åˆå§‹åŒ–ã€‚

å®Œæ•´è¿‡ç¨‹å¦‚ä¸‹ï¼š
```bash
# kind create cluster --name my-cluster
Creating cluster "my-cluster" ...
 âœ“ Ensuring node image (kindest/node:v1.27.1) ğŸ–¼
 âœ“ Preparing nodes ğŸ“¦
 âœ“ Writing configuration ğŸ“œ
 âœ“ Starting control-plane ğŸ•¹ï¸
 âœ“ Installing CNI ğŸ”Œ
 âœ“ Installing StorageClass ğŸ’¾
                                                                        
You can now use your cluster with:

kubectl cluster-info --context kind-my-cluster

Thanks for using kind!
```

**åˆ‡æ¢kindé›†ç¾¤**

ä¸ºä»€ä¹ˆè¦åˆ‡æ¢é›†ç¾¤ï¼Ÿå› ä¸º kind å¯ä»¥åˆå§‹åŒ–å¤šä¸ªé›†ç¾¤ã€‚ä½¿ç”¨æŸä¸ªé›†ç¾¤æ—¶åˆ™éœ€è¦åˆ‡æ¢ã€‚
```bash
kubectl cluster-info --context kind-my-cluster
```

**æŸ¥çœ‹é›†ç¾¤**
```bash
kubectl get nodes
```

**åˆå§‹åŒ–ä¸€ä¸»ä¸¤ä»çš„k8sé›†ç¾¤***
```bash

```

**éªŒè¯**
```bash
kubeadm version
```

## kubeadm åˆå§‹åŒ–é›†ç¾¤ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

**æ‰“å°é»˜è®¤é…ç½®å‚æ•°åˆ°æŒ‡å®šæ–‡ä»¶**
```bash
kubead config print init-defaults > kubeadm-init-temp.yaml
```

æŒ‡å®šé…ç½®æ–‡ä»¶æ–¹å¼åˆå§‹åŒ–

```bash
kubeadm init --config kubeadm-init.yaml
```

```bash
kubectl get nodes
```

```bash
kubectl get pod -A
```

```bash
kubectl apply -f kube-flannel.yml
```



