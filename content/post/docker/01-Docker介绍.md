+++
title = 'Docker介绍'
date = 2018-09-22T00:02:00+08:00
draft = true
categories = [ "Docker" ]
tags = [ "docker" ]
+++

# 传统部署应用流程

![](/images/docker/docker/1.png)

话说 Long long time ago，我们要部署一个 App，需要哪些操作呢？
1. 准备一台物理服务器
2. 在服务器上安装操作系统（Windows、Linux）
3. 在操作系统上部署 Application

思考：这种部署模式有什么缺点呢？

- **部署慢**：需要购买服务器，并部署到指定机房，安装操作系统，然后安装 Application，Application 可能比较复杂，还需要安装一些依赖，这些都需要花费很长时间。
- **成本高**：部署应用需要购买服务器，哪怕部署的应用消耗的资源非常少，它也需要一台物理服务器。
- **资源浪费**：这点主要是第2点延伸，服务器资源太多了，对应用来说可能存在浪费的现象，资源可能用不完。
- **难以迁移和扩展**：迁移时需要另外再准备一台服务器和操作系统，再重新部署；扩展时如果应用用户增长很快，消耗资源很大，一台服务器资源难以满足日益增长的业务需求，可能要另外再买台物理服务器，再做迁移。
- **可能会被限定硬件厂商**：可能有些操作系统是运行在厂商自己的平台的，如果要迁移到其他如 x86 平台，App 可能要做一些改变来兼容

为了解决这个模式中出现的种种问题，就发展出了 `虚拟化技术`。

# 虚拟化技术

![](/images/docker/2.jpg)

## 实现方式

在物理服务器上面通过 `Hypervisor` 去做物理资源的虚拟机化。比如将CPU资源、内存资源、硬盘资源进行虚拟化，然后在这些虚拟化之上再去安装操作系统，这些操作系统其实就是 `虚拟机`。

比如一个物理机的 CPU 和内存都非常多，就可以通过虚拟化技术就虚拟出多个机器，从而可以实现虚机之间资源的调度，如其中一个虚机可以使用 1CPU、1G内存，另一个虚拟机可以使用2CPU、2G内存，可以做物理资源的限定以及调度，从而实现物理资源利用率的最大化。

## 特点
1. 一个物理机就可以部署多个 App
2. 每个 App 独立运行在一个 VM 中

## 优点
- **资源池**：可以把一个物理机的资源可以分配到不同的虚拟机里面，然后去做物理资源的管理。
- **易扩展**：可以增加物理机器或者增加虚拟机。
- **易于云化**：亚马逊AWS、阿里云、腾讯云等。
- **硬件无关**：因为虚拟化，App和底层物理机之间由于虚拟化的存在做了一层隔离，就不需要关系底层的物理机是什么厂商机型（戴尔、IBM），通过虚拟化可以在任何物理设备上创建虚拟机

## 缺点

- 每个虚拟机都是一个完整的操作系统，要给其分配资源，当虚拟机数量增多时，操作系统本身消耗的资源势必增多。
- 虚拟化技术还不足以促进容器技术的发展，容器技术的发展主要还是来源于开发和运维所面临的挑战。

# 容器

## 容器解决什么问题

- 解决了开发和运维之间的矛盾。
- 在开发和运维之间搭建了一个桥梁，是实现devops的最佳解决方案。

## 什么是容器

![](/images/docker/docker/3.png)

1. 容器是对软件和其依赖的标准化打包
2. 容器可以实现应用之间的相互隔离
3. 容器共享同一个OS Kernel
4. 容器可以运行在很多主流操作系统上

## 容器和虚拟机的区别

![](/images/docker/docker/4.jpg)

[](/images/docker/docker/5.png)

## Docker 能做什么

- **简化配置**：可以实现将源代码、运行环境以及配置都打包到一个容器里面，并且这个容器可以运行在不同的环境中，因为配置简化所以自然而然的就提高了开发效率。
- **提高开发效率**：可以统一本地开发环境、测试环境和生产环境，极大的减少在开发和测试以及部署过程中因环境的不同产生的错误。
- **整合服务器**
- **代码流水线管理**
- **调试能力**
- **多租户**
- **隔离应用**
- **快速部署**

    
## 为什么使用Docker

我们可以在Linux系统上直接安装程序然后部署项目，那为什么还要安装docker虚拟机，并在docker虚拟机内部去安装程序部署项目呢？

主要是为了解决隔离性的问题， 有些程序运行会占用大量的硬件资源，比如芒果数据库，运行的时候会占用大量的内存和创建缓存，这点势必会影响到其他程序的运行；

再有使用虚拟机去部署程序会非常的方便，比如我需要部署程序，只需要开启一个虚拟的空间，如果我不需要部署程序了，我只要把虚拟空间删除掉就行了，这些虚拟空间之间是完全隔离的。

如果不使用虚拟机，在Linux系统内安装程序，我要把A程序卸载掉，这个程序关联了一些软件包，当我把A程序卸载掉可能会影响到B程序，B程序跑不起来了，那么这个就体现不了隔离性。这一点Docker虚拟机是可以完全体现隔离性的。把A容器删除掉之后，这个A容器就是Docker虚拟机里面的虚拟空间，我把A容器删掉不会影响到B容器，这个隔离性就非常的好，这就是使用Docker虚拟机去部署项目的主要原因。


> 我们在Linux系统上安装了docker虚拟机，然后开创虚拟空间去部署程序，体现的是隔离性，那为什么不在Linux系统上安装VM虚拟机，用VM虚拟机去部署程序，这也能体现隔离性呀，为什么安装Docker而不是安装VM呢？

Docker虚拟机是一个轻量级的虚拟机，VM虚拟机是一个重量级的虚拟机。我们在一个服务器主机上开启Docker虚拟机之后，创建几千个虚拟的空间，然后一起去启动，一点问题都没有。而VM虚拟机在自己电脑上没法多开，开一个虚拟机对我们的主机负担就挺重的，多开之后就非常卡顿。

## Docker虚拟机架构

> Docker为什么被叫做轻量级的虚拟机呢？

![](/images/docker/1.png)

    Docker创建的所有虚拟实例共占用了同一个Linux内核，对硬件占用较小，属于轻量级虚拟机。

上面的架构图需要从下往上看，我们在硬件环境之上安装了一个操作系统，这个就是宿主机系统，比如我们安装的 CentOS 系统。

然后我们在Linux系统上去安装Docker程序，这个Docker程序内含有的Docker引擎会去管理（如创建，销毁，启动，停止）这些虚拟空间，在这些虚拟空间之内我们可以去安装程序，部署项目，这些虚拟空间我们叫做容器。容器和容器是完全隔离的。需要部署什么东西，我们只需要开启一个容器，然后在里面安装程序，部署项目，不需要就可以直接把容器删除掉就行了，不会对其他容器造成影响。

Docker被称为轻量级的虚拟机原因是因为这些容器里面运行的Linux系统并不是独立的完整的Linux,这些容器运行的Linux其实是共用了一个Linux内核，就是Docker软件为它们提供的Linux系统内核。

而VM虚拟机不是这样的，VM虚拟机每一个虚拟的空间都是运行的一个独立的系统。在VM里面可以安装Windows，也可以安装MacOS,不管安装什么操作系统它们都是独立的操作系统，这个对主机硬件消耗是非常大的，所以VM虚拟机是无法多开的，而Docker却可以多开，就是因为多容器是共享一个Linux内核。

正因为很多容器是共享一个Linux内核，也就是说我们在Docker虚拟机内是没办法安装其他的操作系统的，只能使用Docker提供的Linux系统，然后在容器里面去部署基于Linux系统的程序。   

## Docker镜像与容器

    镜像是用来创建容器的；
    容器是从镜像中创建出来的实例

![](/images/docker/223.png)

镜像的内容是只能读取，不能写入，而容器是可读可写的。这就意味着我们部署项目是部署在容器里面，而不是部署在镜像里面。镜像不是虚拟的空间，容器才是虚拟的空间。创建容器的时候，我们可以指定这个虚拟的空间多大的内存，几核的CPU，什么样的网络环境，所以容器是可以运行的，而镜像是不能运行的，镜像只是一个文件，它里面安装了你想要的一些程序。

> 既然镜像是只读的，那我们怎么往镜像里安装程序呢？

其实Docker还有一种文件叫 `DockerFile`，我们在编写 `Dockerfile` 的时候可以定义我们想要安装的程序，写好这些程序之后，`Dockerfile` 运行时就会把这些程序安装上，然后创建出镜像。当然我们也可以在容器里面安装一些程序，然后把容器转换成镜像。








