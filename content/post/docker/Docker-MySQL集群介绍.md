+++
title = 'MySQL集群介绍'
date = 2018-09-23T09:08:34+08:00
draft = true
categories = [ "Docker" ]
tags = [ "docker" ]
+++

## 单节点数据库弊端

    1.大型互联网程序用户群体庞大，所以架构必须要特殊设计，这也包括了数据库
    2.单节点的数据库无法满足性能上的要求
    3.单节点的数据库没有冗余设计，无法满足高可用

平时在开发过程中使用的数据库大多是单节点的数据库，谈不上高性能高可用。

比如有这样一个案例，大学考试之后，我们要到校园网查看考试成绩，学校一万多人同时到校园网查看考试成绩，我们会发现网页的加载速度非常慢，这个就是数据库单节点无法应对高负载的一个案例。一个数据库实例一万人的并发访问它基本无法支撑下来。

还有一个就是如果我们的数据库采用单节点部署的话，它没有任何的冗余设计，一旦数据库节点出现了宕机，那么所有的业务都不能进行开展了，这也体现不出来高可用。


## 常见MySQL集群方案

### Replication 集群方案

![](/images/docker/27.png)

这种方案存储速度快，具有弱一致性，所谓弱一致性就是我在集群中A节点写入数据，Replication无法保证一定会把这条数据分发到集群的其他节点上，所以就可能出现我在A节点写入数据，我在B节点中查不到这个数据的情况。正因为弱一致性的特点我们不能在Replication集群中保存高价值的数据，所以它适合保存一些如日志数据，新闻数据和论坛帖子数据等。

### PXC集群方案

![](/images/docker/28.png)

这种方案叫 `PXC集群`，它的特点相对于Replication来说存储数据的速度较慢一些，但是它能保证同步数据的强一致性，我在集群的A节点里面写入数据，PXC方案一定会保证这条数据成功地同步到集群的其他节点上，所以它比较适合保存高价值的数据，比如订单数据，账户数据和财务数据等。

## PXC原理

PXC（Percona XtraDB Cluster）

![](/images/docker/29.png)

基于 `PXCGalera` 实现的MySQL集群，在PXC集群里面任何一个数据库节点都是可读可写的，我可以在第一个节点里面写入数据，其他的接点一定会成功的读取到这条数据，因为PXC集群有数据同步的强制性；

另外在PXC进群里的数据库节点都是MySQL的，可以用官方的也可以是其他衍生版，这里推荐的是 `PerconaServer` 的，它是MySQL的改进版，性能有很大的提升。

## 对比

###  PXC方案

![](/images/docker/30.png)

pxc的数据同步是双向的，它在任意一个节点里面写入数据，数据都会同步到其他节点里面，比如说我在第一个节点里面写入了数据，它会同步到第二个，第三个，第四个节点里面，如果我在第二个节点里面写入了数据，它会同步到第一个，第三个，第四个节点里面；

pxc群数据同步是双向的，也就是说我在任何一个MySQL节点上我都是可以同时读写数据的， Replication方案数据同步时单向的，它无法做到任何节点可以同时读写。

### Replication方案

![](/images/docker/31.png)

负责写入数据的节点的角色叫做 `Master`, 我在第一个MySQL节点里面写入一条数据，因为同步是单向的，数据会同步到另外一个MySQL节点里面，这个MySQL的节点名字叫做 `Slave` 节点，那么我在 `Slave` 节点里面是可以读取到这条数据的，而因为数据同步是单向的，所以我们在 `Slave` 节点里面写入了数据，这个数据是不会同步到 `Master` 节点里面，在 `Master` 里面是读取不到这条数据的，也就是说Replication的集群的数据的单向同步导致了集群里面不是每一个节点都是可以同时读写的。

## PXC的数据强一致性

    同步复制，事务在所有集群节点要么同时提交，要么不提交；
    Replication采用异步复制，无法保证数据的一致性。

pxc节点之间分发数据使用的是 `同步复制机制`，而Replication集群之间同步数据利用的是 `异步复制机制`，异步是无法保证数据的强一致性

### PXC的同步复制机制

![](/images/docker/32.png)

![](/images/docker/33.png)

如上图所示，我在第一个MySQL节点写入了数据，并不是我在这个节点写入了数据客户端就知道写入成功了，因为同步机制要求必须在其他的节点里面也成功的写入数据才能算是一次写入的成功，所以我在第一个MySQL节点上写入数据还要通过同步机制把数据同步到其他节点上，并且在其他节点上成功提交事务，最终才算是写入成功，这个时候第一个MySQL节点才会把写入成功的结果告诉MySQL的客户端。

### Replication的异步复制机制

![](/images/docker/224.png)

Replication的异步的同步机制就不是上面说的那样了，比如说我在第一个MySQL节点写入数据，这时Master节点可以写入数据，写入数据时采用异步的同步，就是我不管同步成功不成功，我就直接返回给客户端写入成功的结果，如果这个同步因为一些原因失败了，第二个MySQL节点也就是Slave节点读不出来这个数据。

对于这种情况客户端得到的结果是什么呢？我已经成功的写入了数据，但是写入的数据另一端又读不出来数据，这个问题就非常的严重，比如说我们在淘宝上买一样东西，我们下了订单也付款了，但是我们再次去查询我购买的记录的时候，发现没有这条购买的信息，那么我买了东西扣了钱然后有没有这个订单，这样的结果我们肯定不能接受，所以PXC数据的强一致性对保存高价值的数据非常重要。

