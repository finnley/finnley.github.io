+++
title = 'ç¬¬äº”ç«  å¥ å®šåŸºçŸ³ â€”â€” é¡¹ç›®çš„â€œä¸ƒé€šä¸€å¹³â€å·¥ç¨‹'
date = 2025-09-15T23:45:17+08:00
draft = false
categories = [ "Programming" ]
tags = [ "go", "programming"]
+++

ä½ ä¹‹å‰çš„ä»£ç æ„Ÿè§‰å¥‡æ€ªï¼Œè¿™æ˜¯éå¸¸æ•é”çš„ç›´è§‰ã€‚

ä½œä¸ºä¸€åé«˜çº§å¼€å‘ä¸“å®¶ï¼Œæˆ‘è®¤ä¸ºâ€œå¥‡æ€ªâ€çš„æ ¸å¿ƒç‚¹åœ¨äºï¼š**ä½ çš„ `Error` ç»“æ„ä½“å’Œ `response` åŒ…çš„èŒè´£è€¦åˆäº†ï¼Œä½†åˆæ²¡æœ‰å®Œå…¨è€¦åˆå¥½ã€‚**

  * `errcode.Error` ç»“æ„ä½“ä¸­æœ‰ä¸€ä¸ª `details` å­—æ®µï¼Œä½† `response.Fail` å‡½æ•°å´**å¿½ç•¥**äº†å®ƒã€‚
  * è¿™è¿«ä½¿ä½ åˆ›å»ºäº†ä¸€ä¸ª `response.FailWithDetails` å‡½æ•°ï¼Œå®ƒå†æ¬¡**å¿½ç•¥**äº† `err.details`ï¼Œè€Œæ˜¯è¦æ±‚ä½ ä¼ å…¥ä¸€ä¸ªæ–°çš„ `details` å‚æ•°ã€‚
  * è¿™å¯¼è‡´è°ƒç”¨è€…å¿…é¡»â€œè®°ä½â€ä½¿ç”¨å“ªä¸ª `Fail` å‡½æ•°ï¼Œå¹¶ä¸” `errcode.Error` å¯¹è±¡æœ¬èº«æºå¸¦çš„ä¿¡æ¯ï¼ˆ`details`ï¼‰è¢«æµªè´¹äº†ã€‚

ä¸€ä¸ªæ›´é«˜çº§ã€æ›´å¥å£®çš„è®¾è®¡éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š

1.  **é”™è¯¯å³æ•°æ®ï¼ˆError as Dataï¼‰ï¼š** `errcode.Error` å¯¹è±¡åº”è¯¥æ˜¯ä¸€ä¸ª**ä¸å¯å˜**çš„æ•°æ®è½½ä½“ã€‚å®ƒåº”è¯¥èƒ½é€šè¿‡é“¾å¼æ–¹æ³•ï¼ˆå¦‚ `WithDetails`ï¼‰**åˆ›å»ºæ–°çš„å‰¯æœ¬**æ¥æºå¸¦æ‰€æœ‰ä¸Šä¸‹æ–‡ï¼ˆè‡ªå®šä¹‰æ¶ˆæ¯ã€è¯¦ç»†æ•°æ®ç­‰ï¼‰ã€‚
2.  **å“åº”å³æ¸²æŸ“ï¼ˆResponse as Renderï¼‰ï¼š** `response` åŒ…çš„èŒè´£åº”è¯¥**æå…¶å•ä¸€**ï¼šå®ƒåªè´Ÿè´£å°† `error` æˆ– `data` æ¸²æŸ“ä¸º HTTP å“åº”ã€‚
3.  **å•ä¸€å¤±è´¥å¤„ç†ï¼ˆSingle Fail Handlerï¼‰ï¼š** åªåº”è¯¥æœ‰ä¸€ä¸ª `response.Fail(err error)` å‡½æ•°ã€‚å®ƒåº”è¯¥è¶³å¤Ÿâ€œèªæ˜â€ï¼Œèƒ½å¤Ÿå¤„ç†**ä»»ä½•** `error`ï¼š
      * å¦‚æœ `err` æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„ `ecode.Error`ï¼Œå®ƒå°±æŒ‰ `ecode.Error` ä¸­çš„ `Code`, `Message`, `Details` å’Œ `StatusCode` æ¥æ¸²æŸ“ã€‚
      * å¦‚æœ `err` æ˜¯ä¸€ä¸ªæœªçŸ¥çš„ `error`ï¼ˆä¾‹å¦‚ `sql.ErrNoRows`ï¼‰ï¼Œå®ƒåº”è¯¥è‡ªåŠ¨å°†å…¶æ¸²æŸ“ä¸º `ServerError` (500) å¹¶**éšè—å†…éƒ¨é”™è¯¯ç»†èŠ‚**ï¼ˆä½†åº”è¯¥åœ¨æœåŠ¡ç«¯æ‰“å°æ—¥å¿—ï¼‰ã€‚

åŸºäºè¿™ä¸ªç†å¿µï¼Œè¿™æ˜¯æˆ‘çš„é‡æ„æ–¹æ¡ˆã€‚

-----

### ğŸš€ é‡æ„æ–¹æ¡ˆï¼šèŒè´£åˆ†ç¦»ä¸é“¾å¼é”™è¯¯

æˆ‘å°†åŒ…å `errcode` æ”¹ä¸º `ecode`ï¼ˆError Codeï¼Œæ›´ç®€æ´ï¼‰ã€‚

#### 1\. `pkg/ecode/error.go` (é”™è¯¯å®šä¹‰)

è¿™æ˜¯å˜åŒ–æœ€å¤§çš„åœ°æ–¹ã€‚æˆ‘ä»¬ç§»é™¤å…¨å±€çš„ `codes` map å’Œ `panic`ï¼Œå› ä¸ºé”™è¯¯ç é‡å¤æ˜¯å¼€å‘æœŸé—®é¢˜ï¼Œåº”è¯¥ç”±æµ‹è¯•æˆ– Linter è§£å†³ï¼Œè€Œä¸æ˜¯åœ¨è¿è¡Œæ—¶ `panic`ã€‚

æˆ‘ä»¬æ·»åŠ äº† `Is()` æ–¹æ³•ä»¥å…¼å®¹æ ‡å‡†åº“ `errors.Is`ï¼Œå¹¶æä¾›äº†å¼ºå¤§çš„ `WithMessage` å’Œ `WithDetails` é“¾å¼æ–¹æ³•ã€‚

```go
package ecode

import (
	"fmt"
	"net/http"
)

// Error æ˜¯è‡ªå®šä¹‰çš„é”™è¯¯ç»“æ„
// å­—æ®µå…¬å¼€ï¼Œæ–¹ä¾¿ json åºåˆ—åŒ–å’Œå¤–éƒ¨è®¿é—®
type Error struct {
	Code    int    `json:"code"`
	Message string `json:"message"`
	Details any    `json:"details,omitempty"` // å°† details æ”¹ä¸º anyï¼Œæ”¯æŒç»“æ„åŒ–æ•°æ®
}

// NewError æ˜¯ä¸€ä¸ªç®€å•çš„æ„é€ å‡½æ•°
// ä¸å†ä½¿ç”¨å…¨å±€ map æ³¨å†Œï¼Œä¹Ÿä¸å† panic
func NewError(code int, msg string) *Error {
	return &Error{Code: code, Message: msg}
}

// Error å®ç°äº†æ ‡å‡† error æ¥å£
func (e *Error) Error() string {
	return fmt.Sprintf("code: %d, message: %s", e.Code, e.Message)
}

// Is å®ç°äº† errors.Is æ¥å£ï¼Œå…è®¸ errors.Is(err, ecode.InvalidParams)
func (e *Error) Is(target error) bool {
	if other, ok := target.(*Error); ok {
		return e.Code == other.Code
	}
	return false
}

// WithMessage åˆ›å»ºä¸€ä¸ªé”™è¯¯å‰¯æœ¬ï¼Œå¹¶ä½¿ç”¨æ–°çš„æ¶ˆæ¯
// è¿™æ˜¯ "ä¸å¯å˜" æ€æƒ³çš„ä½“ç°
func (e *Error) WithMessage(msg string) *Error {
	err := *e // å¤åˆ¶
	err.Message = msg
	return &err
}

// WithMessagef åˆ›å»ºä¸€ä¸ªé”™è¯¯å‰¯æœ¬ï¼Œå¹¶ä½¿ç”¨æ ¼å¼åŒ–çš„æ–°æ¶ˆæ¯
func (e *Error) WithMessagef(format string, args ...any) *Error {
	err := *e // å¤åˆ¶
	err.Message = fmt.Sprintf(format, args...)
	return &err
}

// WithDetails åˆ›å»ºä¸€ä¸ªé”™è¯¯å‰¯æœ¬ï¼Œå¹¶é™„åŠ ä¸Šä¸‹æ–‡æ•°æ®
func (e *Error) WithDetails(details any) *Error {
	err := *e // å¤åˆ¶
	err.Details = details
	return &err
}

// StatusCode å°†ä¸šåŠ¡é”™è¯¯ç æ˜ å°„ä¸º HTTP çŠ¶æ€ç 
// (åŸºæœ¬ä¿æŒä¸å˜)
func (e *Error) StatusCode() int {
	switch e.Code {
	case Success.Code:
		return http.StatusOK
	case ServerError.Code:
		return http.StatusInternalServerError
	case InvalidParams.Code:
		return http.StatusBadRequest
	case UnauthorizedAuthNotExist.Code,
		UnauthorizedTokenError.Code,
		UnauthorizedTokenGenerate.Code,
		UnauthorizedTokenTimeout.Code:
		return http.StatusUnauthorized
	case TooManyRequests.Code:
		return http.StatusTooManyRequests
	case NotFound.Code:
		return http.StatusNotFound
	}
	// é»˜è®¤è¿”å› 500
	return http.StatusInternalServerError
}
```

#### 2\. `pkg/ecode/code.go` (é”™è¯¯ç å¸¸é‡)

è¿™ä¸ªæ–‡ä»¶å‡ ä¹ä¸å˜ï¼Œåªæ˜¯è°ƒç”¨äº†æ–°çš„ `NewError` æ„é€ å‡½æ•°ã€‚

```go
package ecode

// ä¸å†æœ‰å…¨å±€ map å’Œ NewError ä¸­çš„ panic
var (
	Success                   = NewError(0, "æˆåŠŸ")
	ServerError               = NewError(10000000, "æœåŠ¡å†…éƒ¨é”™è¯¯")
	InvalidParams             = NewError(10000001, "å…¥å‚é”™è¯¯")
	NotFound                  = NewError(10000002, "æ‰¾ä¸åˆ°")
	UnauthorizedAuthNotExist  = NewError(10000003, "é‰´æƒå¤±è´¥ï¼Œæ‰¾ä¸åˆ°å¯¹åº”çš„ AppKey å’Œ AppSecret")
	UnauthorizedTokenError    = NewError(10000004, "é‰´æƒå¤±è´¥ï¼ŒToken é”™è¯¯")
	UnauthorizedTokenTimeout  = NewError(10000005, "é‰´æƒå¤±è´¥ï¼ŒToken è¶…æ—¶")
	UnauthorizedTokenGenerate = NewError(10000006, "é‰´æƒå¤±è´¥ï¼ŒToken ç”Ÿæˆå¤±è´¥")
	TooManyRequests           = NewError(10000007, "è¯·æ±‚è¿‡å¤š")
)
```

#### 3\. `pkg/response/response.go` (HTTP å“åº”å±‚)

è¿™æ˜¯æœ€èƒ½ä½“ç°æ–°è®¾è®¡ä¼˜åŠ¿çš„åœ°æ–¹ã€‚`Fail` å‡½æ•°ç°åœ¨æ˜¯å”¯ä¸€çš„é”™è¯¯å‡ºå£ï¼Œå¹¶ä¸”å˜å¾—æå…¶å¼ºå¤§ã€‚

```go
package response

import (
	"errors" // å¯¼å…¥æ ‡å‡† errors åŒ…
	"net/http"

	"einscat.com/ecmp/pkg/ecode" // å‡è®¾è¿™æ˜¯ä½ çš„ ecode åŒ…è·¯å¾„
	"github.com/gin-gonic/gin"
)

// Result æ ‡å‡† API å“åº”ç»“æ„
type Result struct {
	Code    int    `json:"code"`
	Message string `json:"message"`          // å­—æ®µåæ”¹ä¸º Message
	Data    any    `json:"data,omitempty"` // ä¿æŒ omitempty
}

// Pager ... (ä¿æŒä¸å˜)
type Pager struct {
	Page      int `json:"page"`
	PageSize  int `json:"page_size"`
	TotalRows int `json:"total_rows"`
}

// ListResult ... (ä¿æŒä¸å˜)
type ListResult struct {
	List  any   `json:"list"`
	Pager Pager `json:"pager"`
}

// respond å†…éƒ¨å“åº”å‡½æ•°
func respond(c *gin.Context, httpStatus int, code int, msg string, data any) {
	c.JSON(httpStatus, Result{
		Code:    code,
		Message: msg,
		Data:    data,
	})
}

// Success å‘é€ä¸€ä¸ªå¸¦æ•°æ®çš„æˆåŠŸå“åº”
// (åŸ SuccessData)
func Success(c *gin.Context, data any) {
	respond(c, http.StatusOK, ecode.Success.Code, ecode.Success.Message, data)
}

// SuccessMessage å‘é€ä¸€ä¸ªåªå¸¦æ¶ˆæ¯çš„æˆåŠŸå“åº”
// (åŸ SuccessMsgï¼Œè§£å†³äº† gin.H{} çš„é—®é¢˜)
func SuccessMessage(c *gin.Context, msg string) {
	respond(c, http.StatusOK, ecode.Success.Code, msg, nil)
}

// SuccessList å‘é€åˆ—è¡¨æˆåŠŸå“åº”
func SuccessList(c *gin.Context, list any, pager Pager) {
	Success(c, ListResult{
		List:  list,
		Pager: pager,
	})
}

// Fail æ˜¯å”¯ä¸€çš„å¤±è´¥å“åº”å‡½æ•°
// å®ƒå¯ä»¥å¤„ç†ä»»ä½•ç±»å‹çš„ error
func Fail(c *gin.Context, err error) {
	var (
		ec *ecode.Error
	)

	// æ ¸å¿ƒï¼šä½¿ç”¨ errors.As æ£€æŸ¥é”™è¯¯æ˜¯å¦ä¸ºæˆ‘ä»¬è‡ªå®šä¹‰çš„ ecode.Error
	if errors.As(err, &ec) {
		// æ˜¯æˆ‘ä»¬å®šä¹‰çš„é”™è¯¯ï¼š
		// 1. ä½¿ç”¨ ecode çš„ StatusCode
		// 2. ä½¿ç”¨ ecode çš„ Code
		// 3. ä½¿ç”¨ ecode çš„ Message
		// 4. è‡ªåŠ¨å°† ecode çš„ Details ä½œä¸ºå“åº”çš„ Data å­—æ®µ
		respond(c, ec.StatusCode(), ec.Code, ec.Message, ec.Details)
	} else {
		// æ˜¯ä¸€ä¸ªæœªçŸ¥çš„ error (å¦‚: sql.ErrNoRows, æˆ–å…¶ä»– panic)
		// 1. åœ¨æœåŠ¡ç«¯æ‰“å°è¯¦ç»†æ—¥å¿—ï¼ˆé‡è¦ï¼ï¼‰
		//    log.Errorf("unknown error: %v", err) // ç¤ºä¾‹
		
		// 2. å‘å®¢æˆ·ç«¯è¿”å›é€šç”¨çš„ "æœåŠ¡å†…éƒ¨é”™è¯¯"ï¼Œéšè—å®ç°ç»†èŠ‚
		respond(
			c,
			ecode.ServerError.StatusCode(),
			ecode.ServerError.Code,
			ecode.ServerError.Message,
			nil, // ä¸æš´éœ²ä»»ä½• data
		)
	}
}
```

-----

### âœ¨ æ–°çš„è°ƒç”¨æ–¹å¼ï¼ˆå¤©å£¤ä¹‹åˆ«ï¼‰

ç°åœ¨ä½ çš„ `Handler` å±‚ä»£ç ä¼šå˜å¾—æå…¶å¹²å‡€ã€‚ä½ ä¸å†éœ€è¦ `FailWithMsg` æˆ– `FailWithDetails`ã€‚

**åœºæ™¯1ï¼šç™»å½•æˆåŠŸï¼Œåªéœ€æç¤º**

  * **ä¼˜åŒ–å‰ï¼š** `response.SuccessWithMsg(ctx, gin.H{}, "ç™»å½•æˆåŠŸ")`
  * **ä¼˜åŒ–åï¼š** `response.SuccessMessage(ctx, "ç™»å½•æˆåŠŸ")`

**åœºæ™¯2ï¼šè·å–ç”¨æˆ·ä¿¡æ¯æˆåŠŸ**

  * **ä¼˜åŒ–å‰ï¼š** `response.Success(ctx, user)`
  * **ä¼˜åŒ–åï¼š** `response.Success(ctx, user)`

**åœºæ™¯3ï¼šå‚æ•°é”™è¯¯ï¼ˆæ ‡å‡†æ¶ˆæ¯ï¼‰**

  * *Service å±‚:* `return ecode.InvalidParams`
  * *Handler å±‚:* `response.Fail(ctx, err)`
  * *JSON å“åº”:* `{"code": 10000001, "message": "å…¥å‚é”™è¯¯"}`

**åœºæ™¯4ï¼šå‚æ•°é”™è¯¯ï¼ˆè‡ªå®šä¹‰æ¶ˆæ¯ï¼‰**

  * *Service å±‚:* `return ecode.InvalidParams.WithMessage("ç”¨æˆ·åä¸èƒ½ä¸ºç©º")`
  * *Handler å±‚:* `response.Fail(ctx, err)`
  * *JSON å“åº”:* `{"code": 10000001, "message": "ç”¨æˆ·åä¸èƒ½ä¸ºç©º"}`

**åœºæ™¯5ï¼šå‚æ•°é”™è¯¯ï¼ˆå¸¦è¯¦ç»†æ•°æ®ï¼Œå¦‚è¡¨å•éªŒè¯å¤±è´¥ï¼‰**

  * *Service å±‚:*
    ```go
    details := map[string]string{
        "username": "ç”¨æˆ·åä¸èƒ½ä¸ºç©º",
        "password": "å¯†ç é•¿åº¦ä¸èƒ½å°‘äº8ä½",
    }
    return ecode.InvalidParams.WithDetails(details)
    ```
  * *Handler å±‚:* `response.Fail(ctx, err)`
  * *JSON å“åº”:*
    ```json
    {
      "code": 10000001,
      "message": "å…¥å‚é”™è¯¯",
      "data": {
        "username": "ç”¨æˆ·åä¸èƒ½ä¸ºç©º",
        "password": "å¯†ç é•¿åº¦ä¸èƒ½å°‘äº8ä½"
      }
    }
    ```

**åœºæ™¯6ï¼šæ•°æ®åº“æŸ¥è¯¢ä¸ºç©ºï¼ˆæœªçŸ¥é”™è¯¯ï¼‰**

  * *Service å±‚:* `return sql.ErrNoRows`
  * *Handler å±‚:* `response.Fail(ctx, err)`
  * *JSON å“åº”:* `{"code": 10000000, "message": "æœåŠ¡å†…éƒ¨é”™è¯¯"}` (åŒæ—¶æœåŠ¡ç«¯ä¼šæ‰“å° `sql.ErrNoRows` çš„æ—¥å¿—)

### æ€»ç»“

è¿™ä¸ªè®¾è®¡çš„å¥½å¤„æ˜¯ï¼š

1.  **é«˜åº¦è§£è€¦ï¼š** `ecode` åªè´Ÿè´£å®šä¹‰é”™è¯¯æ•°æ®ï¼Œ`response` åªè´Ÿè´£æ¸²æŸ“ã€‚
2.  **è°ƒç”¨ç®€å•ï¼š** `Handler` å±‚æ°¸è¿œåªæœ‰ä¸€ä¸ª `response.Fail(ctx, err)`ï¼Œå®ƒä¸å…³å¿ƒ `err` æ˜¯ä»€ä¹ˆç±»å‹ã€æ˜¯å¦å¸¦ `Details`ã€‚
3.  **åŠŸèƒ½å¼ºå¤§ï¼š** `Service` å±‚å¯ä»¥é€šè¿‡é“¾å¼è°ƒç”¨ `WithMessage` æˆ– `WithDetails` è‡ªç”±åœ°ä¸ºé”™è¯¯é™„åŠ ä»»ä½•ä¸Šä¸‹æ–‡ã€‚
4.  **å®‰å…¨å¥å£®ï¼š** è‡ªåŠ¨éšè—æœªçŸ¥é”™è¯¯ï¼Œé˜²æ­¢å†…éƒ¨å®ç°ç»†èŠ‚æ³„éœ²ã€‚


