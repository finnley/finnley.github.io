+++
title = '第十二章 需求分析与系统设计'
date = 2025-11-07T08:47:41+08:00
draft = true
categories = [ "Programming" ]
tags = [ "go", "programming"]
+++



# 需求分析与系统设计

## 简要需求分析

正常来说，如果你工作在国内的互联网公司，那么你收到的需求描述都是非常粗略的。
所以你要掌握快速需求分析的小技巧，主要有三点：
- 参考竞品。应该说大部分互联网的功能都是你抄我我抄你的，所以你基本上可以参考竞品。
- 从不同角度分析：
- 功能角度：功能角度也就是明确我们做到哪些功能，有没有轻重缓急之分，一个具体的功能要做到什么程度。
- 非功能角度：对于中小型公司来说，按照这个顺序去思考安全性 > 扩展性 > 性能。第一个保证你的系统不会被人恶意搞崩，第二个是有限度应对将来的需求变更，第三个是优化用户体验。
- 从正常和异常流程两个角度思考：注意区分业务异常流程和技术异常流程。

注意，如果你的产品经理很称职，你问产品经理就可以。只有在产品经理不称职的情况下，你才需要花费比较多的功夫来分析需求。

站在产品经理和用户角度去想，我怎么使用它，这一步一步可能发生什么，要考虑哪些异常的情况。这时候我们就能捋清楚整个流程会遇到什么样的困难，在哪些地方产品经理可能没有考虑清楚。在哪些流程上可能需要我们预留一些扩展出来。

如果产品经理很尽责，他们会告诉告诉我们，会主动拉个群一起讨论，它预想中的用户会先干嘛后干嘛，每一步他都会帮我们分析清楚，当每一步出错的时候，他预期用于会得到一个什么样的反馈。
就算是产品经理，也不可能想得很周到，这时候就可以研发、产品经理建个群，一起对需求，对需求时一定要打起精神来仔细问清楚。

## 参考竞品

以我们这个验证码登录功能为例，你可以看不同公司的验证码登录的实现。
而后你就需要总结他们的功能特性：
- 大部分公司，在你发送手机验证码之前，都要求你先验证一下，比如说利用拼图，这一步你可以猜测是防止有人恶意触发发送短信。
- 大部分公司，在你发送了一个验证码之后，都不能连续发送，要隔一段时间。
- 大部分公司，在手机号码第一次使用的时候，直接会帮你注册一个账号。
- 大部分公司，手机验证码都有有效期。
- 大部分公司，你访问不同服务，手机验证码都是独立的，例如你在 A 功能上触发了手机验证码，在 B功能上可以立刻触发再次发送验证码。
- 验证码只能使用一次，也就是验证码校验通过之后，这个验证码将无法再次使用。

## 从功能和非功能的角度分析
在功能上，整个需求可以简单描述为：
- 允许用户使用手机号码接受验证码登录。在登录的时候，如果手机号码是一个全新的手机号码，那么直接注册一个新的账号。
- 手机验证码的有效期是 10 分钟。
- 用户一分钟内只能发送一次验证码。
- 用户登录/注册成功之后跳转到首页。

在非功能上：保护系统，防止攻击者恶意发送短信。

## 发送验证码流程

![](/images/programming/160.png)

## 验证码登录流程

![](/images/programming/170.png)

## 深入分析

接下来你要站在一个系统设计的角度去分析，怎么实现这个功能。

“手机验证码登录”讨论了两个事情，一个是验证码，一个是登录。这两个是强耦合的吗？

也就是，别的业务有可能用手机验证码吗？所以，手机验证码应该是一个独立的功能。
- 如果是模块，那么它是一个独立的模块。
- 如果是微服务，那么它是一个独立的微服务。

比如这里有3个事情，手机、验证码、登录，它们是强耦合的关系吗？

除了手机，我还可以使用邮箱；
登录，这必然是一个登录功能；
验证码算是登录的子功能，还是一个独立的功能？这时应该想别的业务是否有用到验证码 

![](/images/programming/180.png)

## 手机验证码功能
进一步你会发现，手机验证码要通过短信来发送，那么短信是不是也会被别的业务使用？

在把它做成一个独立的功能之后，你要进一步想：短信这个东西，有没有可能换供应商？
比如说今天买了腾讯的短信，明天买了阿里的短信，后天买了不知道谁的短信。

![](/images/programming/190.png)

## 综合考虑
综合考虑，你会发现你有两个变化点：
• 不同业务都要用短信功能和验证码功能
• 可能换供应商
所以你就要想，我现在该怎么留出一点点扩展的空间，保证万一后面新的业务要用验证码，我这边不动，或者说少动。
万一要是换了供应商，我这边也可以少动或者不动。

![](/images/programming/200.png)

如上图，短信是最基础的形态，在最底层，其之上有验证码功能，和其他短信功能，验证码之上，登录可以用验证码，支付也可以使用验证码。

## 服务划分
你也可以理解为模块划分。所以你需要：
- 一个独立的短信发送服务。
- 在独立的短信发送服务的基础上，封装一个验证码功能。
- 在验证码功能的基础上，封装一个登录功能。

这就是业务上的超前半步设计，也叫做叠床架屋。

![](/images/programming/210.png)


# 短信服务

在我们之前的分析里面，起点应该是短信服务。因为其它服务都是在它的基础上封装的，所以要最先弄完这个。
而进一步考虑到不同的供应商，所以这一次我们需要从接口设计开始。那好，我们怎么知道该如何设计接口？

## 以特定供应商的短信 API 开始

在大部分业务的初期，你是知道有什么地方有扩展，但不知道将来会怎么扩展。所以你只需要考虑当下的需求，然后做一个简单的抽象，预留出接口就可以。你不能指望，你能够设计一个接口，用上几十年，适配所有的需求变化，这是不现实的。

所以这里我们就选定腾讯的短信服务，来试着抽象一个接口。

![](/images/programming/220.png)

初期设计接口时，我们根本不知道它会扩展成什么样的形态，我们也不会预料到接口的所有变化。所以我们不应该指望能够设计出非常通用的接口，并用上几十年适配所有需求变化，这是不现实的。

真正应该做的是，当针对A的时候，比如只支持腾讯云，那我就在腾讯云的基础上设计一个接口，此时这个接口的抽象程度并不是很高，比如将来引入了B华为云或阿里云，结果发现A这个接口版本无法适配，此时就需要调整接口，让这个接口同时适配A和B。

理想的情况就是在设计A的时候就能遇到到B，那就针对A和B做接口设计。但这种事很难的。

同样的引入C也是一样，要进行调整接口设计。

所以设计接口时，可以先只针对当下提供的实现设计接口，然后提供实现，可以适当的考虑将来可能预料到的变化，但不需要将所有可能得变化，有的没的都预料进来。提前设计和过度设计区别就在这一点。我们可以往前看一点点，但不要看太多。

## 腾讯短信 API
你注意看腾讯短信 API 的特点。
首先是初始化短信客户端，里面要求传入各种鉴权参数。
其次是发送一条短信的请求构造，里面传入的主要是短信
本身相关的参数。关键的是：
- 目标手机号码
- appId：你在腾讯短信上创建的应用的 ID。
- 签名：要求发送的短信必须标记是谁发的。
- 模板：要求你提前在服务商里面配置好，得到模板 ID。
- 参数：发送短信的时候的具体参数。

## 接口抽象
于是你可以总结出来一个东西，对于初始化客户端来说，主要是鉴权。但这本身算是某种特定实现在初始化的时候需要解决的内容。

发送一次消息，需要的参数：目标手机号码、appId、签名、模板、参数。
其中 appId 和签名在我们小微书里面都是固定的，同样可以在初始化的时候指定，但是发送的时候就不用传递参数了。


# 短信验证码登录

## 深入分析验证码的安全问题

验证码一般都是 6 位数字，那么要深入考虑两个安全问题：

1、控制验证码发送频率，避免一下子发送几百万条。

- 同一个手机号码，一分钟以内只能发送一次。
- 验证码有效期十分钟。
- 本身整个系统也有限流，也可以保护住系统。

2、验证码不能被攻击者暴力破解，因为验证码只有 6 位，也就是只有十万种可能，所以不能让用户频繁输入验证码来暴力破解。
- 一个验证码，如果已经验证通过了，那么就不能再用。
- 一个验证码，如果已经三次验证失败，那么这个验证码就不再可用。在这种情况下，只会告诉用户输入的验证码不对，但是不会提示验证码过于频繁失败问题。

注意：这个是业务复杂度，不是技术复杂度，理论上这些规则都是产品经理要告诉你的。你不需要仔细琢磨这些规则，因为你出去工作，换一个业务场景，这些全部用不上

## 验证码服务接口抽象

验证码你很容易想到，它就只有两个接口：

- 发送：根据业务、手机号码，发送验证码。在这个接口里面，要控制住发送频率。
- 验证：验证验证码，在这个接口你要保证验证码不会被暴力破解。

所以这时候我们会在 service 包里面放一个 CodeService，里面定义两个方法。


## 发送验证码

验证码是一个有有效期的东西，所以最适合的存储就是 Redis，并且设置过期时间十分钟。

可以将 Redis 的 key 设置为 phone_code:$biz:$phone 的形态。为了进一步避免恶意发送短信，我们需要控制住发短信的频率。

因此整个思路是：
- 如果 Redis 中没有这个 key，那么就直接发送（说明没有发送过验证码）；
- 如果 Redis 中有这个 key，但是没有过期时间，说明系统异常；
- 如果 key 有过期时间，但是过期时间还有 9 分钟，发送太频发，拒绝；
- 否则，重新发送一个验证码

![](/images/programming/230.png)


## SendCode 实现流程

![alt text](image-1.png)

## 验证码登录接口

![alt text](image-2.png)

# 面试技巧

功能角度很难面出彩，真正可以出彩的是非功能。

装扮前：我做了一个短信登录功能。
装扮后：我做了一个支持高并发的短信登录功能。

装扮前：我做了一个订单功能
装扮后：我做了一个支持高可用、高并发的下单功能。

粗暴讲，面试上来就是三高。

在公司里面，非功能性，尤其是扩展性做好，后面在公司的维护是非常轻松的。

比如提前预留一些接口， 主要是应付产品经理考虑不周全，今天变明天变的现象。

在公司，问你做一个功能要多久，预计3天那就说要5天，为自己预留充足的容错时间。  